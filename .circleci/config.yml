version: 2
jobs:
    build-main:
        working_directory: ~/pulsar-current
        docker:
          - image: circleci/python:3.6.1
          - image: circleci/redis
        steps:
          - checkout
          - run:
              command:
                  make clean && make testall
          - run:
              command:
                  make coverage
    lagacy:
        working_directory: ~/pulsar-legacy
        docker:
          - image: circleci/python:3.5.4
          - image: circleci/redis
        steps:
          - checkout
          - run:
              command:
                  make clean && make testall
    deploy:
        docker:
            working_directory: ~/pulsar-deploy
        docker:
          - image: circleci/python:3.6.4
        steps:
          - checkout

workflows:
  version: 2
  build-deploy:
    jobs:
      - build-main
      - deploy:
          requires:
            - build-main
          filters:
            branches:
              only: deploy
