
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pulsar.apps.socket &mdash; pulsar v0.5b4 documentation</title>
    <link rel="stylesheet" href="../../../static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.5b4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <link rel="top" title="pulsar v0.5b4 documentation" href="../../../index.html" />
    <link rel="up" title="pulsar.apps" href="../apps.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pulsar v0.5b4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../pulsar.html" >pulsar</a> &raquo;</li>
          <li><a href="../apps.html" accesskey="U">pulsar.apps</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
<div class="deck">

    
        <p class="developmentversion">
        Documentation for pulsar's DEVELOPMENT version. Get the 
        <a href="http://packages.python.org/pulsar/">release docs here</a>.
        </p>
    

</div>

      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pulsar.apps.socket</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;Asynchronous application for serving requests</span>
<span class="sd">on a socket. This is the base class of :class:`pulsar.apps.wsgi.WSGIServer`.</span>

<span class="sd">A simple echo server ``script.py`` can be implemented as follow::</span>

<span class="sd">    import pulsar</span>
<span class="sd">    from pulsar.apps.socket import SocketServer</span>
<span class="sd">    </span>
<span class="sd">    class EchoProtocol:</span>
<span class="sd">        &quot;The simplest protocol possible.&quot;</span>
<span class="sd">        def decode(self, data):</span>
<span class="sd">            return bytes(data), bytearray()</span>
<span class="sd">        </span>
<span class="sd">        def encode(self, data):</span>
<span class="sd">            return data</span>
<span class="sd">    </span>
<span class="sd">    def echoserver(actor, socket, **kwargs):</span>
<span class="sd">        kwargs[&#39;protocol_factory&#39;] = EchoProtocol</span>
<span class="sd">        return pulsar.AsyncSocketServer(actor, socket, **kwargs)</span>
<span class="sd">        </span>
<span class="sd">    if __name__ == &#39;__main__&#39;:</span>
<span class="sd">        SocketServer(socket_server_factory=echoserver).start()</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">The main parameter for :class:`SocketServer` is the ``socket_server_factory``</span>
<span class="sd">callable which build a :class:`pulsar.AsyncSocketServer` for each</span>
<span class="sd">:class:`pulsar.Worker` serving the application.</span>

<span class="sd">.. _socket-protocol:</span>

<span class="sd">Protocol</span>
<span class="sd">==============</span>

<span class="sd">The protocol class needs to implement two methods, the ``decode`` for servers</span>
<span class="sd">and the ``encode`` for clients. Both methods accept as input one parameter which</span>
<span class="sd">can be ``bytes`` or a ``bytesarray``.</span>

<span class="sd">The ``decode`` method must return a **two elements tuple** of the form:</span>

<span class="sd"> * ``None``, ``bytesarray``: when more data is needed to form a message.</span>
<span class="sd"> * ``message``, ``bytesarray``: where *message* is a correctly parsed message</span>
<span class="sd">   and *bytesarray* contains data for the next message. </span>

<span class="sd">The ``encode`` method must return ``bytes`` which will be sent to the server.</span>

<span class="sd">Useful settings</span>
<span class="sd">==================</span>
<span class="sd">All standard :ref:`settings &lt;settings&gt;` can be applied to a</span>
<span class="sd">:class:`SocketServer`. These are some of the most important:</span>

<span class="sd">bind</span>
<span class="sd">------</span>
<span class="sd">The :class:`SocketServer` application introduces the additional pulsar settings</span>
<span class="sd">:ref:`bind &lt;setting-bind&gt;` which is used to specify the address</span>
<span class="sd">to bind the server to::</span>

<span class="sd">    python script.py --bind 127.0.0.1:8070</span>

<span class="sd">backlog</span>
<span class="sd">---------   </span>
<span class="sd">To control the concurrency of the server you can use the</span>
<span class="sd">:ref:`backlog &lt;setting-backlog&gt;` settings. For example::</span>

<span class="sd">    python script.py --backlog 1000</span>
<span class="sd">    </span>
<span class="sd">will serve a maximum of 1000 clients per :class:`pulsar.Worker` concurrently.</span>

<span class="sd">keepalive</span>
<span class="sd">---------------</span>
<span class="sd">To control how long a :class:`pulsar.AsyncConnection` is kept alive after the</span>
<span class="sd">last read from the remote client, one can use the</span>
<span class="sd">:ref:`keepalive &lt;setting-keepalive&gt;` setting.</span>

<span class="sd">    python script.py --keepalive 10</span>
<span class="sd">    </span>
<span class="sd">will close a client connection which has been idle for 10 seconds.</span>
<span class="sd"> </span>


<span class="sd">Concurrency</span>
<span class="sd">==================</span>

<span class="sd">When running a :class:`SocketServer` in threading mode::</span>

<span class="sd">    python script.py --concurrency thread</span>
<span class="sd"> </span>
<span class="sd">the number of :class:`pulsar.Worker` serving the application is set to 0 so</span>
<span class="sd">that the application is actually served by the :class:`Arbiter`</span>
<span class="sd">eventloop (we refer this to a single process server).</span>
<span class="sd">This configuration is used when debugging, testing, benchmarking or small</span>
<span class="sd">load servers.</span>

<span class="sd">In addition, a :class:`SocketServer` in multi-process mode is only available for:</span>
<span class="sd">    </span>
<span class="sd"> * Posix systems</span>
<span class="sd"> * Windows running python 3.2 or above.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">pulsar</span>
<span class="kn">from</span> <span class="nn">pulsar</span> <span class="kn">import</span> <span class="n">AsyncIOStream</span>


<span class="k">class</span> <span class="nc">Bind</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">Setting</span><span class="p">):</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s">&quot;Socket Servers&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="s">&#39;socket&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bind&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="s">&quot;--bind&quot;</span><span class="p">]</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="s">&quot;ADDRESS&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">DEFAULT_PORT</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">        The socket to bind.</span>
<span class="s">        </span>
<span class="s">        A string of the form: &#39;HOST&#39;, &#39;HOST:PORT&#39;, &#39;unix:PATH&#39;. An IP is a valid</span>
<span class="s">        HOST.</span>
<span class="s">        &quot;&quot;&quot;</span>
        
<span class="k">class</span> <span class="nc">Keepalive</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">Setting</span><span class="p">):</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s">&quot;Socket Servers&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="s">&#39;socket&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;keepalive&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--keep-alive&quot;</span><span class="p">]</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">pulsar</span><span class="o">.</span><span class="n">validate_pos_int</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">default</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">        The number of seconds to keep an idle client connection</span>
<span class="s">        open.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SocketServer"><a class="viewcode-back" href="../../../apps/socket.html#pulsar.apps.socket.SocketServer">[docs]</a><span class="k">class</span> <span class="nc">SocketServer</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This application bind a socket to a given address and listen for</span>
<span class="sd">requests. The request handler is constructued from the</span>
<span class="sd">:attr:`socket_server_factory` parameter/attribute.</span>
<span class="sd">    </span>
<span class="sd">.. attribute:: socket_server_factory</span>

<span class="sd">    Callable which returns the asynchronous socket server, usually</span>
<span class="sd">    a subclass of :class:`pulsar.AsyncSocketServer`.</span>
<span class="sd">    </span>
<span class="sd">.. attribute:: address</span>

<span class="sd">    The socket address, available once the application has started.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_app_name</span> <span class="o">=</span> <span class="s">&#39;socket&#39;</span>
    <span class="n">socket_server_factory</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">address</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">monitor_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="c"># if the platform does not support multiprocessing sockets set</span>
        <span class="c"># the number of workers to 0.</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_server_factory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Socket server class not specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pulsar</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">has_multiProcessSocket</span>\
            <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">concurrency</span> <span class="o">==</span> <span class="s">&#39;thread&#39;</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># Open the socket and bind to address</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">address</span>
        <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="n">pulsar</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">backlog</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">pulsar</span><span class="o">.</span><span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;Could not open a socket. &#39;</span>
                                              <span class="s">&#39;No address to bind to&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Listening on </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">name</span>
    
    <span class="k">def</span> <span class="nf">worker_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c"># Start the worker by starting the socket server</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_server_factory</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span>
                                       <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">keepalive</span><span class="p">)</span>
        <span class="c"># We add the file descriptor handler</span>
        <span class="n">s</span><span class="o">.</span><span class="n">on_connection_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">handle_fd_event</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">socket_server</span> <span class="o">=</span> <span class="n">s</span>
    
    <span class="k">def</span> <span class="nf">worker_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s">&#39;socket_server&#39;</span><span class="p">):</span>
            <span class="c"># we don&#39;t shut down the socket, simply remove all active</span>
            <span class="c"># connections and othe clean up operations.</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">socket_server</span><span class="o">.</span><span class="n">on_close</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">socket_server</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">on_closed</span>
    
    <span class="k">def</span> <span class="nf">on_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">socket_server</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;socket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;listen_on&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                          <span class="s">&#39;read_timeout&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                          <span class="s">&#39;active_connections&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">active_connections</span><span class="p">,</span>
                          <span class="s">&#39;received_connections&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">received</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

          </div>
        </div>
      </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="../../../index.html">
  <img class="logo" width="200" src="../../../static/pulsar.png" alt="pulsar" title="Pulsar"/>
</a>
</p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pulsar v0.5b4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../pulsar.html" >pulsar</a> &raquo;</li>
          <li><a href="../apps.html" >pulsar.apps</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Luca Sbardella.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  
  _gaq.push(['_setAccount', 'UA-3900561-8']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>