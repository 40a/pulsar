<!DOCTYPE html>



<html>
<head>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <title>pulsar.apps.ds.server &mdash; pulsar 0.8.4-beta.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../static/pulsar.css" type="text/css" />
    <link rel="stylesheet" href="../../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.8.4-beta.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../static/favicon.ico"/>
    <link rel="top" title="pulsar 0.8.4-beta.0 documentation" href="../../../../index.html" />
    <link rel="up" title="pulsar.apps" href="../../apps.html" /> 
</head>
 <body>



    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pulsar 0.8.4-beta.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../apps.html" accesskey="U">pulsar.apps</a> &raquo;</li> 
      </ul>
    </div>
<div class="deck">
<div class="header">
    
        <p class="developmentversion">
        Documentation for pulsar's DEVELOPMENT version. Get the
        <a href="http://pythonhosted.org/pulsar/modules/pulsar/apps/ds/server.html">release docs here</a>.
        </p>
    
</div>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pulsar.apps.ds.server</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Pulsar-ds is a python implementation of the popular redis_</span>
<span class="sd">data store. It uses pulsar asynchronous framework to create a</span>
<span class="sd">single-threaded workers responding to TCP-requests in the same way</span>
<span class="sd">as redis does.</span>

<span class="sd">To run a stand alone server create a script with the following code::</span>


<span class="sd">    from pulsar.apps.data import PulsarDS</span>

<span class="sd">    if __name__ == &#39;__main__&#39;:</span>
<span class="sd">        PulsarDS().start()</span>


<span class="sd">More information on the :ref:`pulsar data store example &lt;tutorials-pulsards&gt;`.</span>

<span class="sd">Check out these benchmarks_</span>

<span class="sd">.. _benchmarks: https://gist.github.com/lsbardel/8068579</span>

<span class="sd">Implementation</span>
<span class="sd">===========================</span>

<span class="sd">Pulsar Data Store Server</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: PulsarDS</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">Storage</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: Storage</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _redis: http://redis.io/</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="nb">reduce</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="kn">import</span> <span class="nn">pulsar</span>
<span class="kn">from</span> <span class="nn">pulsar.apps.socket</span> <span class="kn">import</span> <span class="n">SocketServer</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.config</span> <span class="kn">import</span> <span class="n">Global</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.structures</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Zset</span><span class="p">,</span> <span class="n">Deque</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.pep</span> <span class="kn">import</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span><span class="p">,</span> <span class="n">ispy3k</span><span class="p">,</span> <span class="n">pickle</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pulsar.utils.lua</span> <span class="kn">import</span> <span class="n">Lua</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>     <span class="c"># pragma    nocover</span>
    <span class="n">Lua</span> <span class="o">=</span> <span class="bp">None</span>


<span class="kn">from</span> <span class="nn">.parser</span> <span class="kn">import</span> <span class="n">redis_parser</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">sort_command</span><span class="p">,</span> <span class="n">count_bytes</span><span class="p">,</span> <span class="n">and_op</span><span class="p">,</span> <span class="n">or_op</span><span class="p">,</span> <span class="n">xor_op</span><span class="p">,</span> <span class="n">save_data</span>
<span class="kn">from</span> <span class="nn">.client</span> <span class="kn">import</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">PulsarStoreClient</span><span class="p">,</span> <span class="n">LuaClient</span><span class="p">,</span> <span class="n">Blocked</span><span class="p">,</span>
                     <span class="n">COMMANDS_INFO</span><span class="p">,</span> <span class="n">check_input</span><span class="p">,</span> <span class="n">redis_to_py_pattern</span><span class="p">)</span>


<span class="n">DEFAULT_PULSAR_STORE_ADDRESS</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1:6410&#39;</span>


<span class="k">def</span> <span class="nf">pulsards_url</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span> <span class="ow">or</span> <span class="n">DEFAULT_PULSAR_STORE_ADDRESS</span>
    <span class="k">return</span> <span class="s">&#39;pulsar://</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>


<span class="c"># Keyspace changes notification classes</span>
<span class="n">STRING_LIMIT</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>

<span class="n">nan</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">ispy3k</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
    <span class="n">_ord</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
<span class="k">else</span><span class="p">:</span>   <span class="c"># pragma    nocover</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip_longest</span> <span class="k">as</span> <span class="n">zip_longest</span>
    <span class="n">_ord</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RedisParserSetting</span><span class="p">(</span><span class="n">Global</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;redis_py_parser&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--redis-py-parser&quot;</span><span class="p">]</span>
    <span class="n">action</span> <span class="o">=</span> <span class="s">&quot;store_true&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">    Use the python redis parser rather the C implementation.</span>

<span class="s">    Mainly used for benchmarking purposes.</span>
<span class="s">    &#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">PulsarDsSetting</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">Setting</span><span class="p">):</span>
    <span class="n">virtual</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">app</span> <span class="o">=</span> <span class="s">&#39;pulsards&#39;</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s">&quot;Pulsar data store server&quot;</span>


<span class="k">def</span> <span class="nf">validate_list_of_pairs</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">new_val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Not a list: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Not a list: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elem</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Not a pair: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">))</span>
            <span class="n">new_val</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">new_val</span>


<span class="c"># #############################################################################</span>
<span class="c"># #    CONFIGURATION PARAMETERS</span>
<span class="k">class</span> <span class="nc">KeyValueDatabases</span><span class="p">(</span><span class="n">PulsarDsSetting</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;key_value_databases&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--key-value-databases&quot;</span><span class="p">]</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">default</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;Number of databases for the key value store.&#39;</span>


<span class="k">class</span> <span class="nc">KeyValuePassword</span><span class="p">(</span><span class="n">PulsarDsSetting</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;key_value_password&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--key-value-password&quot;</span><span class="p">]</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;Optional password for the database.&#39;</span>


<span class="k">class</span> <span class="nc">KeyValueSave</span><span class="p">(</span><span class="n">PulsarDsSetting</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;key_value_save&quot;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)]</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">validate_list_of_pairs</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        List of pairs controlling data store persistence.</span>

<span class="s">        Will save the DB if both the given number of seconds and the given</span>
<span class="s">        number of write operations against the DB occurred.</span>

<span class="s">        The default behaviour will be to save:</span>
<span class="s">        after 900 sec (15 min) if at least 1 key changed</span>
<span class="s">        after 300 sec (5 min) if at least 10 keys changed</span>
<span class="s">        after 60 sec if at least 10000 keys changed</span>

<span class="s">        You can disable saving at all by setting an empty list</span>
<span class="s">    &#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">KeyValueFileName</span><span class="p">(</span><span class="n">PulsarDsSetting</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;key_value_filename&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--key-value-filename&quot;</span><span class="p">]</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">&#39;pulsards.rdb&#39;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;The filename where to dump the DB.&#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">TcpServer</span><span class="p">(</span><span class="n">pulsar</span><span class="o">.</span><span class="n">TcpServer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TcpServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser_class</span> <span class="o">=</span> <span class="n">redis_parser</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">redis_py_parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_value_store</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TcpServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_value_store</span><span class="o">.</span><span class="n">_info</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">info</span>


<div class="viewcode-block" id="PulsarDS"><a class="viewcode-back" href="../../../../apps/ds.html#pulsar.apps.ds.server.PulsarDS">[docs]</a><span class="k">class</span> <span class="nc">PulsarDS</span><span class="p">(</span><span class="n">SocketServer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A :class:`.SocketServer` serving a pulsar datastore.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;pulsards&#39;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">pulsar</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">DEFAULT_PULSAR_STORE_ADDRESS</span><span class="p">,</span>
                        <span class="n">keep_alive</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">apps</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;socket&#39;</span><span class="p">,</span> <span class="s">&#39;pulsards&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">server_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TcpServer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">protocol_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">PulsarStoreClient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">monitor_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;workers&#39;</span><span class="p">,</span> <span class="n">workers</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PulsarDS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">monitor_start</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>


<span class="c"># #############################################################################</span>
<span class="c"># #    DATA STORE</span></div>
<span class="n">pubsub_patterns</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;pubsub_patterns&#39;</span><span class="p">,</span> <span class="s">&#39;re clients&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Storage"><a class="viewcode-back" href="../../../../apps/ds.html#pulsar.apps.ds.server.Storage">[docs]</a><span class="k">class</span> <span class="nc">Storage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Implement redis commands.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key_value_password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key_value_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">_loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">_parser_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expired_keys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bpop_blocked_clients</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_save</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># The set of clients which are watching keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watching</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c"># The set of clients which issued the monitor command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">logger</span>
        <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_KEYSPACE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_KEYEVENT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_EXPIRED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_EVICTED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ALL</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span> <span class="o">|</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span> <span class="o">|</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span> <span class="o">|</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_EXPIRED</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_EVICTED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MONITOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MULTI</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BLOCKED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIRTY_CAS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic_event</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_event</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_event</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_event</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_event</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zset_event</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_options</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;ex&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;px&#39;</span><span class="p">,</span> <span class="s">&#39;nx&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;xx&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OK</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;+OK</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QUEUED</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;+QUEUED</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZERO</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;:0</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ONE</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;:1</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NIL</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;$-1</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NULL_ARRAY</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;*-1</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span> <span class="o">=</span> <span class="s">&#39;invalid expire time&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PUBSUB_ONLY</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;only (P)SUBSCRIBE / (P)UNSUBSCRIBE / QUIT &#39;</span>
                            <span class="s">&#39;allowed in this context&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INVALID_SCORE</span> <span class="o">=</span> <span class="s">&#39;Invalid score value&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span> <span class="o">=</span> <span class="s">&#39;Command not yet supported&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OUT_OF_BOUND</span> <span class="o">=</span> <span class="s">&#39;Out of bound&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span> <span class="o">=</span> <span class="s">&#39;Syntax error&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SUBSCRIBE_COMMANDS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;psubscribe&#39;</span><span class="p">,</span> <span class="s">&#39;punsubscribe&#39;</span><span class="p">,</span> <span class="s">&#39;subscribe&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;unsubscribe&#39;</span><span class="p">,</span> <span class="s">&#39;quit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">pickle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span> <span class="o">=</span> <span class="n">Dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span> <span class="o">=</span> <span class="n">Deque</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span> <span class="o">=</span> <span class="n">Zset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bytearray</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zset_aggregate</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="s">&#39;min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
                               <span class="n">b</span><span class="s">&#39;max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span>
                               <span class="n">b</span><span class="s">&#39;sum&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_event_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">bytearray</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span>
                                <span class="nb">set</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_name_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">bytearray</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">:</span> <span class="s">&#39;hash&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">:</span> <span class="s">&#39;list&#39;</span><span class="p">,</span>
                               <span class="nb">set</span><span class="p">:</span> <span class="s">&#39;set&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">:</span> <span class="s">&#39;zset&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">num</span><span class="p">,</span> <span class="n">Db</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">key_value_databases</span><span class="p">)))</span>
        <span class="c"># Initialise lua</span>
        <span class="k">if</span> <span class="n">Lua</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua</span> <span class="o">=</span> <span class="n">Lua</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;redis&#39;</span><span class="p">,</span> <span class="n">LuaClient</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                              <span class="s">&#39;call&#39;</span><span class="p">,</span> <span class="s">&#39;pcall&#39;</span><span class="p">,</span> <span class="s">&#39;error_reply&#39;</span><span class="p">,</span> <span class="s">&#39;status_reply&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">&#39;2.6.16&#39;</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c"># pragma    nocover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lua</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s">&#39;2.4.10&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaddb</span><span class="p">()</span>
        <span class="n">pulsar</span><span class="o">.</span><span class="n">call_repeatedly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cron</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    KEYS COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;del&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">rem</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rem</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">rem</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="o">*</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">expireat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span><span class="p">)</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">timeout</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;ignore&#39;</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="n">allkeys</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span>
        <span class="n">gr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allkeys</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">redis_to_py_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span> <span class="k">if</span> <span class="n">allkeys</span> <span class="ow">or</span>
                  <span class="n">gr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">))]</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">db2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db2</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">value</span>
        <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">db2</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_event_map</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)],</span> <span class="n">db2</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pexpire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pexpireat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expireat</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ttl</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">randomkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">ex</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;Cannot rename key, not available&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key1</span> <span class="o">==</span> <span class="n">key2</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;Cannot rename key&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
            <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_event_map</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
            <span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key2</span><span class="p">,</span> <span class="n">dirty</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">renamenx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;Could not decode value&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_TIMEOUT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">ttl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">sort_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ttl</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_name_map</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_status</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Keys&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    STRING COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">,)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bitcount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">count_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bitop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">reduce_op</span> <span class="o">=</span> <span class="n">and_op</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;or&#39;</span><span class="p">:</span>
            <span class="n">reduce_op</span> <span class="o">=</span> <span class="n">or_op</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;xor&#39;</span><span class="p">:</span>
            <span class="n">reduce_op</span> <span class="o">=</span> <span class="n">xor_op</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;not&#39;</span><span class="p">:</span>
            <span class="n">reduce_op</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;bad command&#39;</span><span class="p">)</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reduce_op</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">~</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s">&#39;fillvalue&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="n">reduce_op</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="s">&#39;-1&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bitoffset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bitoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bitoffset</span> <span class="o">&gt;=</span> <span class="n">STRING_LIMIT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span>
                <span class="s">&quot;bit offset is not an integer or out of range&quot;</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">string</span>
            <span class="n">byte</span> <span class="o">=</span> <span class="n">bitoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">byte</span><span class="p">:</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">bitoffset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;Wrong offset in &#39;</span><span class="si">%s</span><span class="s">&#39; command&quot;</span> <span class="o">%</span>
                                      <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">incr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">incrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">incrbyfloat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">get</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">D</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">msetnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">D</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">exist</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">exist</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exist</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">exist</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">psetex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">milliseconds</span><span class="o">=</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_options</span><span class="p">)</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">milliseconds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">it</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">extra</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;ex&#39;</span><span class="p">:</span>
                    <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">seconds</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;px&#39;</span><span class="p">:</span>
                    <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">milliseconds</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;nx&#39;</span><span class="p">:</span>
                    <span class="n">nx</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">seconds</span><span class="p">,</span>
                     <span class="n">milliseconds</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">xx</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bitoffset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bitoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bitoffset</span> <span class="o">&gt;=</span> <span class="n">STRING_LIMIT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span>
                <span class="s">&quot;bit offset is not an integer or out of range&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;bit is not an integer or out of range&quot;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">string</span>

        <span class="c"># grow value to the right if necessary</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">bitoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
        <span class="n">num_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">byte</span> <span class="o">&gt;=</span> <span class="n">num_bytes</span><span class="p">:</span>
            <span class="n">string</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">byte</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">num_bytes</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># get current value</span>
        <span class="n">byteval</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">bitoffset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">bitval</span> <span class="o">=</span> <span class="n">byteval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>

        <span class="c"># update with new value</span>
        <span class="n">byteval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>
        <span class="n">byteval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>
        <span class="n">string</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">=</span> <span class="n">byteval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span> <span class="k">if</span> <span class="n">bitval</span> <span class="k">else</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">seconds</span><span class="o">=</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nx</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">T</span> <span class="o">&gt;=</span> <span class="n">STRING_LIMIT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;Wrong offset in &#39;</span><span class="si">%s</span><span class="s">&#39; command&quot;</span> <span class="o">%</span>
                                      <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">:</span>
            <span class="n">string</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">string</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">strlen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    HASHES COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hdel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">rem</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">rem</span> <span class="o">+=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hexists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flat</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hincrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hincrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hincrbyfloat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hincrby</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hlen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hmget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hmset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">D</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">value</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">avail</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span> <span class="k">if</span> <span class="n">avail</span> <span class="k">else</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hsetnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Hashes&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hscan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    LIST COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">blpop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bpop</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">blocked</span> <span class="o">=</span> <span class="n">Blocked</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">brpop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blpop</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">brpoplpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bpop</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">blocked</span> <span class="o">=</span> <span class="n">Blocked</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">linsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c"># This method is INEFFICIENT, but redis supported so we do</span>
        <span class="c"># the same here</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">where</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;before&#39;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">where</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;after&#39;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;cannot insert to list&#39;</span><span class="p">)</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l2</span> <span class="o">-</span> <span class="n">l1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">llen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lpop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;lpop&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rpop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpop</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;lpush&#39;</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">extendleft</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lpushx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;lpushx&#39;</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rpushx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpushx</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;invalid range&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lrem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="c"># This method is INEFFICIENT, but redis supported so we do</span>
        <span class="c"># the same here</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;cannot remove from list&#39;</span><span class="p">)</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUT_OF_BOUND</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUT_OF_BOUND</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ltrim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;invalid range&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">value</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span>
                         <span class="n">start</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Lists&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">rpoplpush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">orig</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">dest</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;rpop&#39;</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;lpush&#39;</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    SETS COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">scard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;difference&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sdiffstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;difference&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sinter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;intersection&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sinterstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;intersection&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sismember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">smembers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">smove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">orig</span><span class="p">:</span>
                <span class="c"># we my be able to move</span>
                <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">dest</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dest</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
                <span class="n">orig</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;srem&#39;</span><span class="p">,</span> <span class="n">key1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;sadd&#39;</span><span class="p">,</span> <span class="n">key2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key1</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">spop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">srandmember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;Invalid count&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">count</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,)</span> <span class="o">*</span> <span class="n">count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                        <span class="n">el</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="bp">None</span><span class="p">,)</span><span class="o">*</span><span class="p">(</span><span class="n">count</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                        <span class="n">el</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">srem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_SET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sunion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;union&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sunionstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&#39;union&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sets&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sscan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    SORTED SETS COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">D</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]),</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zcard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zcount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">include_min</span> <span class="o">=</span> <span class="n">include_max</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">min_value</span> <span class="ow">and</span> <span class="n">_ord</span><span class="p">(</span><span class="n">min_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">include_min</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">max_value</span> <span class="ow">and</span> <span class="n">_ord</span><span class="p">(</span><span class="n">max_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">include_max</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">max_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_value</span><span class="p">)</span>
                <span class="n">mmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_SCORE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">mmin</span><span class="p">,</span> <span class="n">mmax</span><span class="p">,</span>
                                             <span class="n">include_min</span><span class="p">,</span> <span class="n">include_max</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zincrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INVALID_SCORE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">increment</span>
            <span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zinterstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zsetoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;zrevrange&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;withscores&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                     <span class="n">value</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrangebyscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">minval</span><span class="p">,</span> <span class="n">include_min</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">include_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_values</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">withscores</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">while</span> <span class="n">request</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;withscores&#39;</span><span class="p">:</span>
                    <span class="n">withscores</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;limit&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">withscores</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span> <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                 <span class="n">value</span><span class="o">.</span><span class="n">range_by_score</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                      <span class="n">start</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                      <span class="n">include_min</span><span class="o">=</span><span class="n">include_min</span><span class="p">,</span>
                                      <span class="n">include_max</span><span class="o">=</span><span class="n">include_max</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">range_by_score</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span>
                                                   <span class="n">start</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                                   <span class="n">include_min</span><span class="o">=</span><span class="n">include_min</span><span class="p">,</span>
                                                   <span class="n">include_max</span><span class="o">=</span><span class="n">include_max</span><span class="p">))</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">remove_items</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zremrangebyrank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">remove_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zremrangebyscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">minval</span><span class="p">,</span> <span class="n">include_min</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">include_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_values</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">remove_range_by_score</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">include_min</span><span class="p">,</span>
                                                  <span class="n">include_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">removed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrevrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zrevrangebyscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zunionstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zsetoper</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Sorted Sets&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">zscan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    PUBSUB COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">psubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="n">redis_to_py_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">pubsub_patterns</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pre</span><span class="p">),</span> <span class="nb">set</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">client</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;psubscribe&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pubsub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">subcommand</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;channels&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">redis_to_py_pattern</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)))</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)):</span>
                        <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;numsub&#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="p">())</span>
                <span class="n">count</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">channel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;numpat&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;Unknown command &#39;pubsub </span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">subcommand</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">channel</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_clients</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_clients</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pattern</span><span class="o">.</span><span class="n">clients</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">punsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">N</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;punsubscribe&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">clients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">clients</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">clients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;subscribe&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Pub/Sub&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">N</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">:</span>
                <span class="n">clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">clients</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                    <span class="n">clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">clients</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;unsubscribe&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    TRANSACTION COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Transactions&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;DISCARD without MULTI&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_transaction</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Transactions&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;exec&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;EXEC without MULTI&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span>
            <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIRTY_CAS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_transaction</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_transaction</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk_len</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">_execute_command</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Transactions&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_replay</span><span class="p">(</span><span class="s">&quot;MULTI calls can not be nested&quot;</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Transactions&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;WATCH inside MULTI is not allowed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wkeys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">watched_keys</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">wkeys</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">=</span> <span class="n">wkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_watching</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="n">wkeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Transactions&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">unwatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_transaction</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">transaction</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    SCRIPTING</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Scripting&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_script</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Scripting&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">evalsha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;the script is not available&#39;</span><span class="p">,</span> <span class="s">&#39;NOSCRIPT&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eval_script</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Scripting&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span>
        <span class="n">subcommand</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;EXISTS&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sha</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">)</span> <span class="k">for</span> <span class="n">sha</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;FLUSH&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">scripts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;KILL&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;LOAD&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">sha</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">scripts</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    CONNECTION COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Connections&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="n">client</span><span class="o">.</span><span class="n">_producer</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;wrong password&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Connections&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Connections&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_status</span><span class="p">(</span><span class="s">&#39;PONG&#39;</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Connections&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Connections&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">D</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">((</span><span class="s">&#39;select requires a database number between &#39;</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">num</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    SERVER COMMANDS</span>
    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bgrewriteaof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bgsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">subcommand</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_list</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;unknown command &#39;client </span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">subcommand</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="ow">not</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">subcommand</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;get&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;&#39;config get&#39; no argument&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;rewrite&#39;</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;set&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;&#39;config set&#39; no argument&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_config</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s">&#39;resetstat&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expired_keys</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_producer</span>
            <span class="n">server</span><span class="o">.</span><span class="n">_received</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">server</span><span class="o">.</span><span class="n">_requests_processed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&quot;&#39;config </span><span class="si">%s</span><span class="s">&#39; not valid&quot;</span> <span class="o">%</span> <span class="n">subcommand</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dbsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">subcommands</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="s">&#39;segfault&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">flushdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">flushall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flat_info</span><span class="p">())</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lastsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_save</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MONITOR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">script</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">slaveof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">slowlog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span><span class="p">)</span>

    <span class="nd">@command</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">microseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1000000</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">seconds</span><span class="p">))</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">seconds</span><span class="p">,</span> <span class="n">microseconds</span><span class="p">))</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    INTERNALS</span>
    <span class="k">def</span> <span class="nf">_cron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span>
        <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_save</span>
            <span class="k">for</span> <span class="n">interval</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">key_value_save</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gap</span> <span class="o">&gt;=</span> <span class="n">interval</span> <span class="ow">and</span> <span class="n">dirty</span> <span class="o">&gt;=</span> <span class="n">changes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">()</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">milliseconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">nx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">xx</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
            <span class="n">milliseconds</span> <span class="o">=</span> <span class="mf">0.000001</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">milliseconds</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;invalid expire time&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">+</span> <span class="n">milliseconds</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">nx</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">xx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_expires</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">_do_expire</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;expire&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_incrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tv</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;invalid increment&#39;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tv</span> <span class="o">+=</span> <span class="nb">type</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="s">&#39;invalid increment&#39;</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_STRING</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tv</span>

    <span class="k">def</span> <span class="nf">_bpop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">list_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">list_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_block_callback</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_block_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;br&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">dval</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">dval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">()</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">dval</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;rpop&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">dval</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;lpush&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_LIST</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;lpop&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">elem</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_range_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">_close_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="n">client</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">client</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">client</span><span class="o">.</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">DIRTY_CAS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watching</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flat_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s">&#39;server&#39;</span><span class="p">][</span><span class="s">&#39;redis_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_info_value</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s">&#39;#</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">k</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                           <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_encode_info_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span>
                                  <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span>
                                               <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; - &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hincrby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span>
                <span class="s">&#39;value is not an </span><span class="si">%s</span><span class="s"> or out of range&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hash</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">hash</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">hash</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span>
                    <span class="s">&#39;hash value is not an </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="n">increment</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="nb">hash</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_HASH</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">increment</span>

    <span class="k">def</span> <span class="nf">_setoper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">oper</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">oper</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">reply_zero</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_zsetoper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">check_input</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">db</span>
        <span class="n">cmnd</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">des</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">numkeys</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">numkeys</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">numkeys</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;at least 1 input key is needed for &#39;</span>
                                 <span class="s">&#39;ZUNIONSTORE/ZINTERSTORE&#39;</span><span class="p">)</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="o">+</span><span class="n">numkeys</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">()</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_wrongtype</span><span class="p">()</span>
                <span class="n">sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numkeys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;numkeys does not match number of sets&#39;</span><span class="p">)</span>
            <span class="n">op</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">b</span><span class="s">&#39;weights&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;aggregate&#39;</span><span class="p">))</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">numkeys</span><span class="p">:]</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="nb">sum</span>
            <span class="k">while</span> <span class="n">request</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;weights&#39;</span><span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">numkeys</span><span class="p">]]</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">numkeys</span><span class="p">:]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_aggregate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERRO</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">numkeys</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numkeys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cmnd</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;zunionstore&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zset_type</span><span class="o">.</span><span class="n">inter</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">des</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">des</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NOTIFY_ZSET</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_score_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
        <span class="n">include_min</span> <span class="o">=</span> <span class="n">include_max</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">min_value</span> <span class="ow">and</span> <span class="n">_ord</span><span class="p">(</span><span class="n">min_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">include_min</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">min_value</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">max_value</span> <span class="ow">and</span> <span class="n">_ord</span><span class="p">(</span><span class="n">max_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">include_max</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">max_value</span> <span class="o">=</span> <span class="n">max_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_value</span><span class="p">),</span> <span class="n">include_min</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_value</span><span class="p">),</span> <span class="n">include_max</span>

    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keyspace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;keyspace_hits&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_keys</span><span class="p">,</span>
                 <span class="s">&#39;keyspace_misses&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missed_keys</span><span class="p">,</span>
                 <span class="s">&#39;expired_keys&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expired_keys</span><span class="p">,</span>
                 <span class="s">&#39;keys_changed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">,</span>
                 <span class="s">&#39;pubsub_channels&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="p">),</span>
                 <span class="s">&#39;pubsub_patterns&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="p">),</span>
                 <span class="s">&#39;blocked_clients&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bpop_blocked_clients</span><span class="p">}</span>
        <span class="n">persistance</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;rdb_changes_since_last_save&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">,</span>
                       <span class="s">&#39;rdb_last_save_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_save</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
                <span class="n">keyspace</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">)]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;keyspace&#39;</span><span class="p">:</span> <span class="n">keyspace</span><span class="p">,</span>
                <span class="s">&#39;stats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
                <span class="s">&#39;persistance&#39;</span><span class="p">:</span> <span class="n">persistance</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_client_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">_producer</span><span class="o">.</span><span class="n">_concurrent_connections</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_info</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_client_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s">&#39;addr=</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">client</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s">&#39;addr&#39;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&#39;fd=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">client</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">_sock_fd</span>
        <span class="k">yield</span> <span class="s">&#39;age=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">client</span><span class="o">.</span><span class="n">started</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&#39;db=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">client</span><span class="o">.</span><span class="n">database</span>
        <span class="k">yield</span> <span class="s">&#39;sub=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&#39;psub=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&#39;cmd=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">client</span><span class="o">.</span><span class="n">last_command</span>

    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span>
        <span class="k">if</span> <span class="n">writer</span> <span class="ow">and</span> <span class="n">writer</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Cannot save, background saving in progress&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_save</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving database in background process&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">save_data</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving database&#39;</span><span class="p">)</span>
                <span class="n">save_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dbs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">db</span><span class="o">.</span><span class="n">_num</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loaddb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;loading data from &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">+=</span> <span class="n">dirty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="p">[</span><span class="nb">type</span><span class="p">](</span><span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">COMMANDS_INFO</span><span class="p">[</span><span class="n">command</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_publish_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">clients</span><span class="p">):</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">clients</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">clients</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="c"># EVENT HANDLERS</span>
    <span class="k">def</span> <span class="nf">_modified_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watching</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">watched_keys</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIRTY_CAS</span>

    <span class="k">def</span> <span class="nf">_generic_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modified_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">_string_event</span> <span class="o">=</span> <span class="n">_generic_event</span>
    <span class="n">_set_event</span> <span class="o">=</span> <span class="n">_generic_event</span>
    <span class="n">_hash_event</span> <span class="o">=</span> <span class="n">_generic_event</span>
    <span class="n">_zset_event</span> <span class="o">=</span> <span class="n">_generic_event</span>

    <span class="k">def</span> <span class="nf">_list_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modified_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c"># the key is blocking clients</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_blocking_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_expires</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_blocking_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">client</span><span class="o">.</span><span class="n">blocked</span><span class="o">.</span><span class="n">unblock</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c"># Remove a client from the server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watching</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span><span class="p">,</span> <span class="n">clients</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">clients</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">clients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_channels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_to_monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c"># addr = &#39;%s:%s&#39; % self._transport.get_extra_info(&#39;addr&#39;)</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&quot; &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;+</span><span class="si">%s</span><span class="s"> [0 </span><span class="si">%s</span><span class="s">] &quot;&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">cmds</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;&quot;</span><span class="se">\r\n</span><span class="s">&#39;</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_eval_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">numkeys</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">numkeys</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="o">+</span><span class="n">numkeys</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numkeys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">elif</span> <span class="n">numkeys</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYNTAX_ERROR</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">numkeys</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">set_global</span><span class="p">(</span><span class="s">&#39;KEYS&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">set_global</span><span class="p">(</span><span class="s">&#39;ARGV&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">keyu</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">keyu</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;OK&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_ok</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">keyu</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;ERR&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_error</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">array</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_multi_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_one</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">reply_bulk</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">Db</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The database.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num</span> <span class="o">=</span> <span class="n">num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">_loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_keys</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;db</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num</span>
    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">)</span>

    <span class="c"># #########################################################################</span>
    <span class="c"># #    INTERNALS</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="p">[</span><span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;flushdb&#39;</span><span class="p">,</span>
                           <span class="n">dirty</span><span class="o">=</span><span class="n">removed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span>

    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="n">handle</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span>
            <span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_expire</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">handle</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">handle</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">_when</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;Keys&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>
                <span class="s">&#39;expires&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
                <span class="n">handle</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">rem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_hit_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">handle</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">NOTIFY_GENERIC</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;del&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_missed_keys</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_do_expire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="p">:</span>
            <span class="n">handle</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_expired_keys</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="../../../../index.html">
  <img class="logo" width="200" src="../../../../static/pulsar.png" alt="pulsar" title="Pulsar"/>
</a>
</p>
<div class="g-plusone"></div>
<script type="text/javascript">
  window.___gcfg = {lang: 'en-GB'};
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<br>
<a href="https://twitter.com/share" class="twitter-share-button" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<br>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


<div class="footer">
     &copy; Copyright 2011-2014, Luca Sbardella.
   Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b1.
 </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  
  _gaq.push(['_setAccount', 'UA-3900561-8']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>