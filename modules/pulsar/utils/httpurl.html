

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pulsar.utils.httpurl &mdash; pulsar 1.1.3beta0 documentation</title>
    
    <link rel="stylesheet" href="../../../static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pulsar.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.1.3beta0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../static/favicon.ico"/>
    <link rel="top" title="pulsar 1.1.3beta0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pulsar.utils.httpurl</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;This is a substantial module which imporfts several classes and functions</span>
<span class="sd">from the standard library in a python 2.6 to python 3.3 compatible fashion.</span>
<span class="sd">On top of that, it implements the :class:`HttpClient` for handling synchronous</span>
<span class="sd">and asynchronous HTTP requests in a pythonic way.</span>

<span class="sd">It is a thin layer on top of urllib2 in python2 / urllib in Python 3.</span>
<span class="sd">Several opensource efforts have been used as source of snippets:</span>

<span class="sd">* http-parser_</span>
<span class="sd">* request_</span>
<span class="sd">* urllib3_</span>
<span class="sd">* werkzeug_</span>


<span class="sd">.. _tools-http-headers:</span>

<span class="sd">HTTP Headers</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: Headers</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _tools-http-parser:</span>

<span class="sd">HTTP Parser</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: HttpParser</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _http-parser: https://github.com/benoitc/http-parser</span>
<span class="sd">.. _urllib3: https://github.com/shazow/urllib3</span>
<span class="sd">.. _request: https://github.com/kennethreitz/requests</span>
<span class="sd">.. _werkzeug: https://github.com/mitsuhiko/werkzeug</span>
<span class="sd">.. _`HTTP cookie`: http://en.wikipedia.org/wiki/HTTP_cookie</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">email.utils</span> <span class="kn">import</span> <span class="n">formatdate</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">urllibr</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">httpclient</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">splitport</span>
<span class="kn">from</span> <span class="nn">http.cookiejar</span> <span class="kn">import</span> <span class="n">CookieJar</span><span class="p">,</span> <span class="n">Cookie</span>
<span class="kn">from</span> <span class="nn">http.cookies</span> <span class="kn">import</span> <span class="n">SimpleCookie</span>

<span class="kn">from</span> <span class="nn">.structures</span> <span class="kn">import</span> <span class="n">mapping_iterator</span>
<span class="kn">from</span> <span class="nn">.string</span> <span class="kn">import</span> <span class="n">to_bytes</span><span class="p">,</span> <span class="n">to_string</span>
<span class="kn">from</span> <span class="nn">.html</span> <span class="kn">import</span> <span class="n">capfirst</span>

<span class="c1"># try:</span>
<span class="c1">#     from http_parser.parser import HttpParser as CHttpParser</span>
<span class="c1">#     hasextensions = True</span>
<span class="c1">#     _Http_Parser = CHttpParser</span>
<span class="c1"># except ImportError:  # pragma    nocover</span>
<span class="c1">#     hasextensions = False</span>
<span class="c1">#     _Http_Parser = None</span>
<span class="c1">#</span>
<span class="c1"># The http_parser has several bugs, therefore it is switched off</span>
<span class="n">hasextensions</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">_Http_Parser</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">setDefaultHttpParser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>   <span class="c1"># pragma    nocover</span>
    <span class="k">global</span> <span class="n">_Http_Parser</span>
    <span class="n">_Http_Parser</span> <span class="o">=</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">http_parser</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_Http_Parser</span>
    <span class="k">return</span> <span class="n">_Http_Parser</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>    <span class="c1"># Compiled with SSL?</span>
    <span class="n">BaseSSLError</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ssl</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="kn">import</span> <span class="nn">ssl</span>
    <span class="n">BaseSSLError</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>   <span class="c1"># pragma : no cover</span>
    <span class="k">pass</span>


<span class="n">getproxies_environment</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">getproxies_environment</span>
<span class="n">ascii_letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
<span class="n">HTTPError</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">HTTPError</span>
<span class="n">URLError</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">URLError</span>
<span class="n">request_host</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">request_host</span>
<span class="n">parse_http_list</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">parse_http_list</span>


<span class="k">class</span> <span class="nc">SSLError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="s2">&quot;Raised when SSL certificate fails in an HTTPS connection.&quot;</span>
    <span class="k">pass</span>

<span class="c1"># ###################################################    URI &amp; IRI SUFF</span>
<span class="c1">#</span>
<span class="c1"># The reserved URI characters (RFC 3986 - section 2.2)</span>
<span class="c1"># Default is charset is &quot;iso-8859-1&quot; (latin-1) from section 3.7.1</span>
<span class="c1"># http://www.ietf.org/rfc/rfc2616.txt</span>
<span class="n">DEFAULT_CHARSET</span> <span class="o">=</span> <span class="s1">&#39;ISO-8859-1&#39;</span>
<span class="n">URI_GEN_DELIMS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s1">&#39;:/?#[]@&#39;</span><span class="p">)</span>
<span class="n">URI_SUB_DELIMS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;!$&amp;&#39;()*+,;=&quot;</span><span class="p">)</span>
<span class="n">URI_RESERVED_SET</span> <span class="o">=</span> <span class="n">URI_GEN_DELIMS</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">URI_SUB_DELIMS</span><span class="p">)</span>
<span class="n">URI_RESERVED_CHARS</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">URI_RESERVED_SET</span><span class="p">)</span>
<span class="c1"># The unreserved URI characters (RFC 3986 - section 2.3)</span>
<span class="n">URI_UNRESERVED_SET</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;-._~&#39;</span><span class="p">)</span>
<span class="n">URI_SAFE_CHARS</span> <span class="o">=</span> <span class="n">URI_RESERVED_CHARS</span> <span class="o">+</span> <span class="s1">&#39;%~&#39;</span>
<span class="n">HEADER_TOKEN_CHARS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;!#$%&amp;&#39;*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
                               <span class="s1">&#39;^_`abcdefghijklmnopqrstuvwxyz|~&#39;</span><span class="p">)</span>
<span class="n">MAX_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">65536</span>


<span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">quote</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">urlquote</span><span class="p">(</span><span class="n">iri</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">quote</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="n">URI_RESERVED_CHARS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_gen_unquote</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="n">unreserved_set</span> <span class="o">=</span> <span class="n">URI_UNRESERVED_SET</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">to_string</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;latin1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">part</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unreserved_set</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">c</span> <span class="o">+</span> <span class="n">part</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">part</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">part</span>


<span class="k">def</span> <span class="nf">unquote_unreserved</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Un-escape any percent-escape sequences in a URI that are unreserved</span>
<span class="sd">characters. This leaves all reserved, illegal and non-ASCII bytes encoded.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_gen_unquote</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requote_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Re-quote the given URI.</span>

<span class="sd">    This function passes the given URI through an unquote/quote cycle to</span>
<span class="sd">    ensure that it is fully and consistently quoted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unquote only the unreserved characters</span>
    <span class="c1"># Then quote only illegal characters (do not quote reserved, unreserved,</span>
    <span class="c1"># or &#39;%&#39;)</span>
    <span class="k">return</span> <span class="n">quote</span><span class="p">(</span><span class="n">unquote_unreserved</span><span class="p">(</span><span class="n">uri</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="n">URI_SAFE_CHARS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">iri_to_uri</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert an Internationalised Resource Identifier (IRI) portion</span>
<span class="sd">    to a URI portion that is suitable for inclusion in a URL.</span>
<span class="sd">    This is the algorithm from section 3.1 of RFC 3987.</span>
<span class="sd">    Returns an ASCII native string containing the encoded result.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">iri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iri</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">iri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_string</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span> <span class="s1">&#39;latin1&#39;</span><span class="p">),</span>
                         <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kv</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
    <span class="k">return</span> <span class="n">urlquote</span><span class="p">(</span><span class="n">unquote_unreserved</span><span class="p">(</span><span class="n">iri</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">host_and_port</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="k">if</span> <span class="n">port</span> <span class="k">else</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;80&#39;</span>
    <span class="k">elif</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;443&#39;</span>


<span class="k">def</span> <span class="nf">host_and_port_default</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span>


<span class="k">def</span> <span class="nf">host_no_default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">netloc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">port</span> <span class="ow">and</span> <span class="n">port</span> <span class="o">==</span> <span class="n">default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">host</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">netloc</span>


<span class="k">def</span> <span class="nf">get_hostport</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">full_host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host_and_port</span><span class="p">(</span><span class="n">full_host</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>         <span class="c1"># ipv6 addresses have [...]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">host</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># http://foo.com:/ == http://foo.com/</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">InvalidURL</span><span class="p">(</span><span class="s2">&quot;nonnumeric port: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                                <span class="o">%</span> <span class="n">host</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">default_port</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span> <span class="ow">and</span> <span class="n">host</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">remove_double_slash</span><span class="p">(</span><span class="n">route</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">in</span> <span class="n">route</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;/+&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">route</span>


<span class="c1"># ###################################################    CONTENT TYPES</span>
<span class="n">JSON_CONTENT_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;application/javascript&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;text/json&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;text/x-json&#39;</span><span class="p">)</span>
<span class="c1"># ###################################################    REQUEST METHODS</span>
<span class="n">ENCODE_URL_METHODS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
<span class="n">ENCODE_BODY_METHODS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TRACE&#39;</span><span class="p">])</span>
<span class="n">REDIRECT_CODES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">has_empty_content</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;204, 304 and 1xx codes have no content&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NO_CONTENT</span> <span class="ow">or</span>\
            <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NOT_MODIFIED</span> <span class="ow">or</span>\
            <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span>\
            <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">is_succesful</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;2xx status is succesful&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">300</span>


<span class="c1"># ###################################################    HTTP HEADERS</span>
<span class="n">WEBSOCKET_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="n">HEADER_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;general&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Pragma&#39;</span><span class="p">,</span> <span class="s1">&#39;Trailer&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Transfer-Encoding&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;Sec-WebSocket-Extensions&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Sec-WebSocket-Protocol&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Via&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">)),</span>
                 <span class="c1"># The request-header fields allow the client to pass</span>
                 <span class="c1"># additional information about the request, and about the</span>
                 <span class="c1"># client to the server.</span>
                 <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Charset&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Language&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Cookie&#39;</span><span class="p">,</span> <span class="s1">&#39;Expect&#39;</span><span class="p">,</span> <span class="s1">&#39;From&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Host&#39;</span><span class="p">,</span> <span class="s1">&#39;If-Match&#39;</span><span class="p">,</span> <span class="s1">&#39;If-Modified-Since&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;If-None-Match&#39;</span><span class="p">,</span> <span class="s1">&#39;If-Range&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;If-Unmodified-Since&#39;</span><span class="p">,</span> <span class="s1">&#39;Max-Forwards&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Proxy-Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;Range&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Referer&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Sec-WebSocket-Version&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;TE&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">)),</span>
                 <span class="c1"># The response-header fields allow the server to pass</span>
                 <span class="c1"># additional information about the response which cannot be</span>
                 <span class="c1"># placed in the Status- Line.</span>
                 <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s1">&#39;Accept-Ranges&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Age&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;ETag&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Location&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Proxy-Authenticate&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Retry-After&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Sec-WebSocket-Accept&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Server&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Set-Cookie2&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Vary&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;X-Frame-Options&#39;</span><span class="p">)),</span>
                 <span class="s1">&#39;entity&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s1">&#39;Allow&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Encoding&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Content-Language&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Content-Location&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-MD5&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Expires&#39;</span><span class="p">,</span> <span class="s1">&#39;Last-Modified&#39;</span><span class="p">))}</span>

<span class="n">CLIENT_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
    <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">],</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">])</span>
<span class="n">SERVER_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
    <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">],</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">])</span>
<span class="n">ALL_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">CLIENT_HEADER_FIELDS</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">SERVER_HEADER_FIELDS</span><span class="p">)</span>
<span class="n">ALL_HEADER_FIELDS_DICT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ALL_HEADER_FIELDS</span><span class="p">))</span>
<span class="n">CRLF</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
<span class="n">LWS</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1"> &#39;</span>
<span class="n">TYPE_HEADER_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="n">CLIENT_HEADER_FIELDS</span><span class="p">,</span>
                      <span class="s1">&#39;server&#39;</span><span class="p">:</span> <span class="n">SERVER_HEADER_FIELDS</span><span class="p">,</span>
                      <span class="s1">&#39;both&#39;</span><span class="p">:</span> <span class="n">ALL_HEADER_FIELDS</span><span class="p">}</span>

<span class="n">header_type</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">}</span>
<span class="n">header_type_to_int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">header_type</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">capfirst</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">b</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">header_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">HEADERS_SET</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a header `name` in Camel case.</span>

<span class="sd">    For example::</span>

<span class="sd">        header_field(&#39;connection&#39;) == &#39;Connection&#39;</span>
<span class="sd">        header_field(&#39;accept-charset&#39;) == &#39;Accept-Charset&#39;</span>

<span class="sd">    If ``header_set`` is given, only return headers included in the set.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;x-&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ALL_HEADER_FIELDS_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">HEADERS_SET</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span> <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">HEADERS_SET</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="c1">#    HEADERS UTILITIES</span>
<span class="n">HEADER_FIELDS_JOINER</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="s1">&#39;; &#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Set-Cookie&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="s1">&#39;Set-Cookie2&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">split_comma</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">parse_cookies</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">OutputString</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">SimpleCookie</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>


<span class="n">header_parsers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="n">split_comma</span><span class="p">,</span>
                  <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="n">parse_cookies</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">header_values</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">header_parsers</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">header_parsers</span><span class="p">[</span><span class="n">header</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">quote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">extra_chars</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_token</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quote a header value if necessary.</span>

<span class="sd">    :param value: the value to quote.</span>
<span class="sd">    :param extra_chars: a list of extra characters to skip quoting.</span>
<span class="sd">    :param allow_token: if this is enabled token values are returned</span>
<span class="sd">        unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_token</span><span class="p">:</span>
        <span class="n">token_chars</span> <span class="o">=</span> <span class="n">HEADER_TOKEN_CHARS</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra_chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">token_chars</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unquote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_filename</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unquotes a header value.</span>

<span class="sd">    Reversal of :func:`quote_header_value`. This does not use the real</span>
<span class="sd">    un-quoting but what browsers are actually using for quoting.</span>

<span class="sd">    :param value: the header value to unquote.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="c1"># this is not the real unquoting, but fixing this so that the</span>
        <span class="c1"># RFC is met will result in bugs with internet explorer and</span>
        <span class="c1"># probably some other browsers as well.  IE for example is</span>
        <span class="c1"># uploading files with &quot;C:\foo\bar.txt&quot; as filename</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># if this is a filename and the starting characters look like</span>
        <span class="c1"># a UNC path, then just return the value without quotes.  Using the</span>
        <span class="c1"># replace sequence below on a UNC path has the effect of turning</span>
        <span class="c1"># the leading double slash into a single slash and then</span>
        <span class="c1"># _fix_ie_filename() doesn&#39;t work correctly.  See #458.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_filename</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">parse_dict_header</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse lists of key, value pairs as described by RFC 2068 Section 2 and</span>
<span class="sd">    convert them into a python dict:</span>

<span class="sd">    &gt;&gt;&gt; d = parse_dict_header(&#39;foo=&quot;is a fish&quot;, bar=&quot;as well&quot;&#39;)</span>
<span class="sd">    &gt;&gt;&gt; type(d) is dict</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; sorted(d.items())</span>
<span class="sd">    [(&#39;bar&#39;, &#39;as well&#39;), (&#39;foo&#39;, &#39;is a fish&#39;)]</span>

<span class="sd">    If there is no value for a key it will be `None`:</span>

<span class="sd">    &gt;&gt;&gt; parse_dict_header(&#39;key_without_value&#39;)</span>
<span class="sd">    {&#39;key_without_value&#39;: None}</span>

<span class="sd">    To create a header from the :class:`dict` again, use the</span>
<span class="sd">    :func:`dump_header` function.</span>

<span class="sd">    :param value: a string with a dict header.</span>
<span class="sd">    :return: :class:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parse_http_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">continue</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unquote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">_special</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;()&lt;&gt;@,;:</span><span class="se">\\</span><span class="s1">&quot;/[]?={} </span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">_re_special</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">_special</span><span class="p">)</span>
<span class="n">_qstr</span> <span class="o">=</span> <span class="s1">&#39;&quot;(?:</span><span class="se">\\\\</span><span class="s1">.|[^&quot;])*&quot;&#39;</span>  <span class="c1"># Quoted string</span>
<span class="n">_value</span> <span class="o">=</span> <span class="s1">&#39;(?:[^</span><span class="si">%s</span><span class="s1">]+|</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_special</span><span class="p">,</span> <span class="n">_qstr</span><span class="p">)</span>  <span class="c1"># Save or quoted string</span>
<span class="n">_option</span> <span class="o">=</span> <span class="s1">&#39;(?:;|^)\s*([^</span><span class="si">%s</span><span class="s1">]+)\s*=\s*(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_special</span><span class="p">,</span> <span class="n">_value</span><span class="p">)</span>
<span class="n">_re_option</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_option</span><span class="p">)</span>  <span class="c1"># key=value part of an Content-Type header</span>


<span class="k">def</span> <span class="nf">header_unquote</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">or</span> <span class="n">val</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># fix ie6 bug: full path --&gt; filename</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">parse_options_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="p">{}</span>
    <span class="n">ctype</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">_re_option</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">tail</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">header_unquote</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;filename&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">options</span>


<div class="viewcode-block" id="Headers"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers">[docs]</a><span class="k">class</span> <span class="nc">Headers</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Utility for managing HTTP headers for both clients and servers.</span>

<span class="sd">    It has a dictionary like interface with few extra functions to facilitate</span>
<span class="sd">    the insertion of multiple header values. Header fields are</span>
<span class="sd">    **case insensitive**, therefore doing::</span>

<span class="sd">        &gt;&gt;&gt; h = Headers()</span>
<span class="sd">        &gt;&gt;&gt; h[&#39;Content-Length&#39;] = &#39;1050&#39;</span>

<span class="sd">    is equivalent to</span>

<span class="sd">        &gt;&gt;&gt; h[&#39;content-length&#39;] = &#39;1050&#39;</span>

<span class="sd">    :param headers: optional iterable over header field/value pairs.</span>
<span class="sd">    :param kind: optional headers type, one of ``server``, ``client`` or</span>
<span class="sd">        ``both``.</span>
<span class="sd">    :param strict: if ``True`` only valid headers field will be included.</span>

<span class="sd">    This :class:`Headers` container maintains an ordering as suggested by</span>
<span class="sd">    http://www.w3.org/Protocols/rfc2616/rfc2616.html:</span>

<span class="sd">    .. epigraph::</span>

<span class="sd">        The order in which header fields with differing field names are</span>
<span class="sd">        received is not significant. However, it is &quot;good practice&quot; to send</span>
<span class="sd">        general-header fields first, followed by request-header or</span>
<span class="sd">        response-header fields, and ending with the entity-header fields.</span>

<span class="sd">        -- rfc2616 section 4.2</span>

<span class="sd">    The strict parameter is rarely used and it forces the omission on</span>
<span class="sd">    non-standard header fields.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">headers</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">header_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span> <span class="o">=</span> <span class="n">TYPE_HEADER_FIELDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span> <span class="o">=</span> <span class="n">TYPE_HEADER_FIELDS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ordered</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">header_type_to_int</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.update"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extend the headers with an ``iterable``.</span>

<span class="sd">        :param iterable: a dictionary or an iterable over keys, vaues tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Headers.override"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.override">[docs]</a>    <span class="k">def</span> <span class="nf">override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Extend headers by overriding fields form iterable.</span>

<span class="sd">        :param iterable: a dictionary or an iterable over keys, vaues tuples.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">joiner</span> <span class="o">=</span> <span class="n">HEADER_FIELDS_JOINER</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">joiner</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">joiner</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span>
        <span class="k">return</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">header_values</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Headers.get"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the field value at ``key`` as comma separated values.</span>

<span class="sd">        For example::</span>

<span class="sd">            &gt;&gt;&gt; from pulsar.utils.httpurl import Headers</span>
<span class="sd">            &gt;&gt;&gt; h = Headers(kind=&#39;client&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.add_header(&#39;accept-encoding&#39;, &#39;gzip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.add_header(&#39;accept-encoding&#39;, &#39;deflate&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.get(&#39;accept-encoding&#39;)</span>

<span class="sd">        results in::</span>

<span class="sd">            &#39;gzip, deflate&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span></div>

<div class="viewcode-block" id="Headers.get_all"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the values at header ``key`` as a list rather than a</span>
<span class="sd">        string separated by comma (which is returned by the</span>
<span class="sd">        :meth:`get` method).</span>

<span class="sd">        For example::</span>

<span class="sd">            &gt;&gt;&gt; from pulsar.utils.httpurl import Headers</span>
<span class="sd">            &gt;&gt;&gt; h = Headers(kind=&#39;client&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.add_header(&#39;accept-encoding&#39;, &#39;gzip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.add_header(&#39;accept-encoding&#39;, &#39;deflate&#39;)</span>
<span class="sd">            &gt;&gt;&gt; h.get_all(&#39;accept-encoding&#39;)</span>

<span class="sd">        results in::</span>

<span class="sd">            [&#39;gzip&#39;, &#39;deflate&#39;]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="Headers.has"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.has">[docs]</a>    <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if ``value`` is avialble in header ``field``.&#39;&#39;&#39;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">()):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.clear"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Same as :meth:`dict.clear`, it removes all headers.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="Headers.getheaders"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.getheaders">[docs]</a>    <span class="k">def</span> <span class="nf">getheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>  <span class="c1"># pragma    nocover</span>
        <span class="sd">&#39;&#39;&#39;Required by cookielib in python 2.</span>

<span class="sd">        If the key is not available, it returns an empty list.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="Headers.add_header"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.add_header">[docs]</a>    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add ``values`` to ``key`` header.</span>

<span class="sd">        If the header is already available, append the value to the list.</span>

<span class="sd">        :param key: header name</span>
<span class="sd">        :param values: a string value or a list/tuple of strings values</span>
<span class="sd">            for header ``key``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">header_values</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
                    <span class="n">current</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span></div>

<div class="viewcode-block" id="Headers.remove_header"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.remove_header">[docs]</a>    <span class="k">def</span> <span class="nf">remove_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove the header at ``key``.</span>

<span class="sd">        If ``value`` is provided, it removes only that value if found.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">removed</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="k">return</span> <span class="n">removed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Headers.flat"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.Headers.flat">[docs]</a>    <span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Full headers bytes representation&#39;&#39;&#39;</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;HTTP/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vs</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">joiner</span> <span class="o">=</span> <span class="n">HEADER_FIELDS_JOINER</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">joiner</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hf</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span>
        <span class="n">hj</span> <span class="o">=</span> <span class="n">HEADER_FIELDS_JOINER</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;general&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                 <span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="p">(</span><span class="s1">&#39;entity&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>    <span class="c1"># non-standard header</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">joiner</span> <span class="o">=</span> <span class="n">hj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dj</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">joiner</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">yield</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">joiner</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">yield</span> <span class="s1">&#39;&#39;</span>
        <span class="k">yield</span> <span class="s1">&#39;&#39;</span></div>


<span class="c1">###############################################################################</span>
<span class="c1">#    HTTP PARSER</span>
<span class="c1">###############################################################################</span>
<span class="n">METHOD_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[A-Z0-9$-_.]{3,20}&quot;</span><span class="p">)</span>
<span class="n">VERSION_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;HTTP/(\d+).(\d+)&quot;</span><span class="p">)</span>
<span class="n">STATUS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(\d{3})\s*(\w*)&quot;</span><span class="p">)</span>
<span class="n">HEADER_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[</span><span class="se">\x00</span><span class="s2">-</span><span class="se">\x1F\x7F</span><span class="s2">()&lt;&gt;@,;:\[\]={} </span><span class="se">\t\\\\\&quot;</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="c1"># errors</span>
<span class="n">BAD_FIRST_LINE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">INVALID_HEADER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">INVALID_CHUNK</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">InvalidRequestLine</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised when first line is invalid &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">InvalidHeader</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised on invalid header &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">InvalidChunkSize</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised when we parse an invalid chunk size &quot;&quot;&quot;</span>


<div class="viewcode-block" id="HttpParser"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser">[docs]</a><span class="k">class</span> <span class="nc">HttpParser</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;A python HTTP parser.</span>

<span class="sd">    Original code from https://github.com/benoitc/http-parser</span>

<span class="sd">    2011 (c) Benoit Chesneau &lt;benoitc@e-engura.org&gt;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">decompress</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span> <span class="o">=</span> <span class="n">decompress</span>
        <span class="c1"># errors vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># protected variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trailers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># private events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># decompress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_first_try</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span>

    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="k">def</span> <span class="nf">get_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span>

    <span class="k">def</span> <span class="nf">get_status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>

    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="k">def</span> <span class="nf">get_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span>

    <span class="k">def</span> <span class="nf">get_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span>

    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

<div class="viewcode-block" id="HttpParser.recv_body"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.recv_body">[docs]</a>    <span class="k">def</span> <span class="nf">recv_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return last chunk of the parsed body&quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">body</span></div>

<div class="viewcode-block" id="HttpParser.is_headers_complete"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.is_headers_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_headers_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if all headers have been parsed. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span></div>

<div class="viewcode-block" id="HttpParser.is_partial_body"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.is_partial_body">[docs]</a>    <span class="k">def</span> <span class="nf">is_partial_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if a chunk of body have been parsed &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span></div>

<div class="viewcode-block" id="HttpParser.is_message_begin"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.is_message_begin">[docs]</a>    <span class="k">def</span> <span class="nf">is_message_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if the parsing start &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span></div>

<div class="viewcode-block" id="HttpParser.is_message_complete"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.is_message_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_message_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if the parsing is done (we get EOF) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span></div>

<div class="viewcode-block" id="HttpParser.is_chunked"><a class="viewcode-back" href="../../../api/utilities.html#pulsar.utils.httpurl.HttpParser.is_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">is_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if Transfer-Encoding header value is chunked&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span></div>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="c1"># end of body can be passed manually by putting a length of 0</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="n">length</span>
        <span class="c1">#</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># start to parse</span>
        <span class="n">nb_parsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">first_line</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">),</span>
                                           <span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
                    <span class="n">rest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_firstline</span><span class="p">(</span><span class="n">first_line</span><span class="p">):</span>
                        <span class="n">nb_parsed</span> <span class="o">=</span> <span class="n">nb_parsed</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">nb_parsed</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">to_parse</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">to_parse</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">length</span>
                    <span class="n">nb_parsed</span> <span class="o">=</span> <span class="n">nb_parsed</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_parse</span><span class="p">)</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidHeader</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">INVALID_HEADER</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">nb_parsed</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">length</span>
                <span class="k">elif</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret</span>
                <span class="k">elif</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">return</span> <span class="n">length</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nb_parsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_parse_firstline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># auto detect</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_request_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidRequestLine</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_request_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidRequestLine</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">BAD_FIRST_LINE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_parse_response_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># version</span>
        <span class="n">matchv</span> <span class="o">=</span> <span class="n">VERSION_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">matchv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s2">&quot;Invalid HTTP version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matchv</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchv</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># status</span>
        <span class="n">matchs</span> <span class="o">=</span> <span class="n">STATUS_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">matchs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s2">&quot;Invalid status %&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchs</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">matchs</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_request_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># Method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">METHOD_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s2">&quot;invalid Method: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># URI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="s1">&#39;http://dummy.com</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">fragment</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Version</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">VERSION_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s2">&quot;Invalid HTTP version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_parse_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># we don&#39;t have all headers</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">to_string</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
        <span class="c1"># Split lines on \r\n keeping the \r\n on each line</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">deque</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)))</span>
        <span class="c1"># Parse headers into key/value pairs paying attention</span>
        <span class="c1"># to continuation lines.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="c1"># Parse initial header name : value pair.</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">HEADER_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidHeader</span><span class="p">(</span><span class="s2">&quot;invalid header name </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()]</span>
            <span class="c1"># Consume value continuation lines</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="c1"># detect now if body is sent by chunks.</span>
        <span class="n">clen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Transfer-Encoding&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Transfer-Encoding&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="p">(</span><span class="n">te</span> <span class="o">==</span> <span class="s1">&#39;chunked&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NO_CONTENT</span> <span class="ow">or</span>
                       <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NOT_MODIFIED</span> <span class="ow">or</span>
                       <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span>      <span class="c1"># 1xx codes</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">):</span>
            <span class="n">clen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">clen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">clen</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">clen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># ignore nonsensical negative lengths</span>
                    <span class="n">clen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">clen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen</span> <span class="o">=</span> <span class="n">clen</span>
        <span class="c1">#</span>
        <span class="c1"># detect encoding and set decompress object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span> <span class="ow">and</span> <span class="s1">&#39;Content-Encoding&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s2">&quot;gzip&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="mi">16</span><span class="o">+</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_first_try</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s2">&quot;deflate&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">()</span>

        <span class="n">rest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">:</span>    <span class="c1"># message complete only for servers</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># maybe decompress</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">size</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_chunk_size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidChunkSize</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">INVALID_CHUNK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="s2">&quot;invalid chunk size [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">body_part</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[:</span><span class="n">size</span><span class="p">],</span> <span class="n">rest</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>

            <span class="c1"># maybe decompress</span>
            <span class="n">body_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span> <span class="k">if</span> <span class="n">rest</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_parse_chunk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">rest_chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidChunkSize</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_trailers</span><span class="p">(</span><span class="n">rest_chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">rest_chunk</span>

    <span class="k">def</span> <span class="nf">_parse_trailers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trailers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">deco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span>
        <span class="k">if</span> <span class="n">deco</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_first_try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">deco</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">deco</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">zlib</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="o">-</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>
                    <span class="n">deco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">deco</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_first_try</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">data</span></div>


<span class="k">if</span> <span class="ow">not</span> <span class="n">hasextensions</span><span class="p">:</span>   <span class="c1"># pragma    nocover</span>
    <span class="n">setDefaultHttpParser</span><span class="p">(</span><span class="n">HttpParser</span><span class="p">)</span>


<span class="c1"># ############################################    UTILITIES, ENCODERS, PARSERS</span>
<span class="n">absolute_http_url_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;^https?://&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_absolute_uri</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check if a ``location`` is absolute, i.e. it includes the scheme</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">absolute_http_url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_environ_proxies</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dict of environment proxies. From requests_.&quot;&quot;&quot;</span>

    <span class="n">proxy_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;all&#39;</span><span class="p">,</span>
        <span class="s1">&#39;http&#39;</span><span class="p">,</span>
        <span class="s1">&#39;https&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ftp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;socks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ws&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wss&#39;</span><span class="p">,</span>
        <span class="s1">&#39;no&#39;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_proxy&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proxy_keys</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proxies</span> <span class="k">if</span> <span class="n">val</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">appendslash</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Append a slash to *url* if it does not have one.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="n">url</span>
    <span class="k">return</span> <span class="n">url</span>


<span class="k">def</span> <span class="nf">choose_boundary</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Our embarassingly-simple replacement for mimetools.choose_boundary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>


<span class="k">def</span> <span class="nf">get_content_type</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;application/octet-stream&#39;</span>


<span class="k">def</span> <span class="nf">encode_multipart_formdata</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encode a dictionary of ``fields`` using the multipart/form-data format.</span>

<span class="sd">    :param fields:</span>
<span class="sd">        Dictionary of fields or list of (key, value) field tuples.  The key is</span>
<span class="sd">        treated as the field name, and the value as the body of the form-data</span>
<span class="sd">        bytes. If the value is a tuple of two elements, then the first element</span>
<span class="sd">        is treated as the filename of the form-data section.</span>

<span class="sd">        Field names and filenames must be unicode.</span>

<span class="sd">    :param boundary:</span>
<span class="sd">        If not specified, then a random boundary will be generated using</span>
<span class="sd">        :func:`mimetools.choose_boundary`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span> <span class="ow">or</span> <span class="s1">&#39;utf-8&#39;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">choose_boundary</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;--</span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;Content-Disposition: form-data; name=&quot;</span><span class="si">%s</span><span class="s1">&quot;; &#39;</span>
                        <span class="s1">&#39;filename=&quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                       <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;Content-Type: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">get_content_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;Content-Disposition: form-data; name=&quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;--</span><span class="si">%s</span><span class="s1">--</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">boundary</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;multipart/form-data; boundary=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">boundary</span>
    <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">content_type</span>


<span class="k">def</span> <span class="nf">hexmd5</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">hexsha1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sha1</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">http_date</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the time to match the RFC1123 date format as specified by HTTP</span>
<span class="sd">    RFC2616 section 3.3.1.</span>

<span class="sd">    Accepts a floating point number expressed in seconds since the epoch, in</span>
<span class="sd">    UTC - such as that outputted by time.time(). If set to None, defaults to</span>
<span class="sd">    the current time.</span>

<span class="sd">    Outputs a string in the format &#39;Wdy, DD Mon YYYY HH:MM:SS GMT&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">formatdate</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="p">,</span> <span class="n">usegmt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="c1"># ################################################################# COOKIES</span>
<span class="k">def</span> <span class="nf">create_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a cookie from underspecified parameters.</span>

<span class="sd">    By default, the pair of `name` and `value` will be set for the domain &#39;&#39;</span>
<span class="sd">    and sent on every request (this is sometimes called a &quot;supercookie&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">expires</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">discard</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">comment_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">rest</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;HttpOnly&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
        <span class="n">rfc2109</span><span class="o">=</span><span class="bp">False</span><span class="p">,)</span>
    <span class="n">badargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">badargs</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;create_cookie() got unexpected keyword arguments: </span><span class="si">%s</span><span class="s1">&#39;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">badargs</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;port_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;domain_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;domain_initial_dot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;path_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Cookie</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cookiejar_from_dict</span><span class="p">(</span><span class="o">*</span><span class="n">cookie_dicts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a CookieJar from a key/value dictionary.</span>

<span class="sd">    :param cookie_dict: Dict of key/values to insert into CookieJar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cookie_dicts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cookie_dicts</span> <span class="k">if</span> <span class="n">d</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cookie_dicts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cookie_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CookieJar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cookie_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cookiejar</span> <span class="o">=</span> <span class="n">CookieJar</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cookie_dict</span> <span class="ow">in</span> <span class="n">cookie_dicts</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cookie_dict</span><span class="p">,</span> <span class="n">CookieJar</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">cookie_dict</span><span class="p">:</span>
                <span class="n">cookiejar</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cookie_dict</span><span class="p">:</span>
                <span class="n">cookiejar</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">create_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cookie_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cookiejar</span>


<span class="c1"># ################################################################# VARY HEADER</span>
<span class="n">cc_delim_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\s*,\s*&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">patch_vary_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">newheaders</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds (or updates) the &quot;Vary&quot; header in the given HttpResponse object.</span>

<span class="sd">    newheaders is a list of header names that should be in &quot;Vary&quot;. Existing</span>
<span class="sd">    headers in &quot;Vary&quot; aren&#39;t removed.</span>

<span class="sd">    For information on the Vary header, see:</span>

<span class="sd">        http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.44</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note that we need to keep the original order intact, because cache</span>
    <span class="c1"># implementations may rely on the order of the Vary contents in, say,</span>
    <span class="c1"># computing an MD5 hash.</span>
    <span class="k">if</span> <span class="s1">&#39;Vary&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">cc_delim_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Vary&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vary_headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Use .lower() here so we treat headers as case-insensitive.</span>
    <span class="n">existing_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">])</span>
    <span class="n">additional_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">newheader</span> <span class="k">for</span> <span class="n">newheader</span> <span class="ow">in</span> <span class="n">newheaders</span>
                          <span class="k">if</span> <span class="n">newheader</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_headers</span><span class="p">]</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vary_headers</span> <span class="o">+</span> <span class="n">additional_headers</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">has_vary_header</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">header_query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if the response has a given header name in its Vary header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="s1">&#39;Vary&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">cc_delim_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Vary&#39;</span><span class="p">])</span>
    <span class="n">existing_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">header_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">existing_headers</span>


<span class="k">class</span> <span class="nc">CacheControl</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    http://www.mnot.net/cache_docs/</span>

<span class="sd">.. attribute:: maxage</span>

<span class="sd">    Specifies the maximum amount of time that a representation will be</span>
<span class="sd">    considered fresh.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">must_revalidate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxy_revalidate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">nostore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span> <span class="o">=</span> <span class="n">maxage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">private</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_revalidate</span> <span class="o">=</span> <span class="n">must_revalidate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_revalidate</span> <span class="o">=</span> <span class="n">proxy_revalidate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nostore</span> <span class="o">=</span> <span class="n">nostore</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nostore</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;no-store, no-cache, must-revalidate,&#39;</span>
                                        <span class="s1">&#39; max-age=0&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;max-age=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_revalidate</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;must-revalidate&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_revalidate</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;proxy-revalidate&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no-cache&#39;</span>


<span class="k">def</span> <span class="nf">chunk_encoding</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write a chunk::</span>

<span class="sd">        chunk-size(hex) CRLF</span>
<span class="sd">        chunk-data CRLF</span>

<span class="sd">    If the size is 0, this is the last chunk, and an extra CRLF is appended.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%X</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">head</span> <span class="o">+</span> <span class="n">chunk</span> <span class="o">+</span> <span class="n">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">http_chunks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_CHUNK_SIZE</span><span class="p">:</span>
        <span class="n">chunk</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">MAX_CHUNK_SIZE</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">MAX_CHUNK_SIZE</span><span class="p">:]</span>
        <span class="k">yield</span> <span class="n">chunk_encoding</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">chunk_encoding</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">finish</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">chunk_encoding</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../static/pulsar-logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Concurrent framework for python 3.4 and above.</p>



<p>
<iframe src="https://ghbtns.com/github-btn.html?user=quantmind&repo=pulsar&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advantage.html">Pulsar Advantage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials &amp; Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pics.html">Pics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/socket.html">Socket Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/wsgi/index.html">WSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/rpc.html">JSON-RPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/websockets.html">WebSockets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/http.html">Asynchronous HTTP client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/pulse.html">Django Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/greenio.html">Greenlet Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/test.html">Test Suite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/ds.html">Pulsar Data Store Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apps/data/index.html">Data Stores</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../oldchangelog.html">Changelog Pre Pulsar 1.0</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-2016, Luca Sbardella.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3900561-8']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>