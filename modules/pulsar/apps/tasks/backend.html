<!DOCTYPE html>



<html>
<head>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <title>pulsar.apps.tasks.backend &mdash; pulsar 0.8.0-beta.5 documentation</title>
    
    <link rel="stylesheet" href="../../../../static/pulsar.css" type="text/css" />
    <link rel="stylesheet" href="../../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.8.0-beta.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../static/favicon.ico"/>
    <link rel="top" title="pulsar 0.8.0-beta.5 documentation" href="../../../../index.html" />
    <link rel="up" title="pulsar.apps.tasks" href="../tasks.html" /> 
</head>
 <body>



    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pulsar 0.8.0-beta.5 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../apps.html" >pulsar.apps</a> &raquo;</li>
          <li><a href="../tasks.html" accesskey="U">pulsar.apps.tasks</a> &raquo;</li> 
      </ul>
    </div>
<div class="deck">
<div class="header">
    
        <p class="developmentversion">
        Documentation for pulsar's DEVELOPMENT version. Get the
        <a href="http://pythonhosted.org/pulsar/modules/pulsar/apps/tasks/backend.html">release docs here</a>.
        </p>
    
</div>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pulsar.apps.tasks.backend</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The :class:`TaskBackend` is at the heart of the</span>
<span class="sd">:ref:`task queue application &lt;apps-taskqueue&gt;`. It exposes</span>
<span class="sd">all the functionalities for running new tasks, scheduling periodic tasks</span>
<span class="sd">and retrieving task information. Pulsar ships with two backends, one which uses</span>
<span class="sd">pulsar internals and store tasks in the arbiter domain and another which stores</span>
<span class="sd">tasks in redis_.</span>

<span class="sd">The backend is created by the :class:`.TaskQueue`</span>
<span class="sd">as soon as it starts. It is then passed to all task queue workers</span>
<span class="sd">which, in turns, invoke the :class:`TaskBackend.start` method</span>
<span class="sd">to start pulling tasks form the distributed task queue.</span>

<span class="sd">Implementation</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>
<span class="sd">When creating a new :class:`TaskBackend` there are six methods which must</span>
<span class="sd">be implemented:</span>

<span class="sd">* The :meth:`~TaskBackend.get_task` method, invoked when retrieving</span>
<span class="sd">  a :class:`Task` from the backend server.</span>
<span class="sd">* The :meth:`~TaskBackend.get_tasks` method, invoked when retrieving</span>
<span class="sd">  a group of :class:`Task` from the backend server.</span>
<span class="sd">* The :meth:`~TaskBackend.save_task` method, invoked when creating</span>
<span class="sd">  or updating a :class:`Task`.</span>
<span class="sd">* The :meth:`~TaskBackend.delete_tasks` method, invoked when deleting</span>
<span class="sd">  a bunch of :class:`Task`.</span>
<span class="sd">* The :meth:`~TaskBackend.flush` method, invoked flushing a backend (remove</span>
<span class="sd">  all tasks and clear the task queue).</span>

<span class="sd">For example::</span>

<span class="sd">    from pulsar.apps import tasks</span>

<span class="sd">    class TaskBackend(tasks.TaskBackend):</span>
<span class="sd">        ...</span>

<span class="sd">Once the custom task backend is implemented it must be registered::</span>

<span class="sd">    tasks.task_backends[&#39;mybackend&#39;] = TaskBackend</span>

<span class="sd">And the backend will be selected via::</span>

<span class="sd">    --task-backend mybackend://host:port</span>

<span class="sd">.. _task-state:</span>

<span class="sd">Task states</span>
<span class="sd">~~~~~~~~~~~~~</span>

<span class="sd">A :class:`Task` can have one of the following :attr:`~.Task.status` string:</span>

<span class="sd">* ``PENDING`` A task waiting to be queued for execution.</span>
<span class="sd">* ``QUEUED`` A task queued but not yet executed.</span>
<span class="sd">* ``RETRY`` A task is retrying calculation.</span>
<span class="sd">* ``STARTED`` task where execution has started.</span>
<span class="sd">* ``REVOKED`` the task execution has been revoked. One possible reason could be</span>
<span class="sd">  the task has timed out.</span>
<span class="sd">* ``UNKNOWN`` task execution is unknown.</span>
<span class="sd">* ``FAILURE`` task execution has finished with failure.</span>
<span class="sd">* ``SUCCESS`` task execution has finished with success.</span>

<span class="sd">.. _task-run-state:</span>

<span class="sd">**FULL_RUN_STATES**</span>

<span class="sd">The set of states for which a :class:`Task` has run:</span>
<span class="sd">``FAILURE`` and ``SUCCESS``</span>

<span class="sd">.. _task-ready-state:</span>

<span class="sd">**READY_STATES**</span>

<span class="sd">The set of states for which a :class:`Task` has finished:</span>
<span class="sd">``REVOKED``, ``FAILURE`` and ``SUCCESS``</span>

<span class="sd">.. _tasks-pubsub:</span>

<span class="sd">Task status broadcasting</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">A :class:`TaskBackend` broadcast :class:`Task` state into three different</span>
<span class="sd">channels via the :attr:`~TaskBackend.pubsub` handler.</span>


<span class="sd">.. _redis: http://redis.io/</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>

<span class="kn">from</span> <span class="nn">pulsar</span> <span class="kn">import</span> <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">EventHandler</span><span class="p">,</span> <span class="n">PulsarException</span><span class="p">,</span> <span class="n">get_logger</span><span class="p">,</span>
                    <span class="n">Future</span><span class="p">,</span> <span class="n">coroutine_return</span><span class="p">,</span> <span class="n">get_request_loop</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.pep</span> <span class="kn">import</span> <span class="n">itervalues</span><span class="p">,</span> <span class="n">to_string</span>
<span class="kn">from</span> <span class="nn">pulsar.apps.data</span> <span class="kn">import</span> <span class="n">create_store</span><span class="p">,</span> <span class="n">PubSubClient</span><span class="p">,</span> <span class="n">odm</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.log</span> <span class="kn">import</span> <span class="p">(</span><span class="n">LocalMixin</span><span class="p">,</span> <span class="n">lazyproperty</span><span class="p">,</span> <span class="n">lazymethod</span><span class="p">,</span>
                              <span class="n">LazyString</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">JobRegistry</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">states</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;task_backends&#39;</span><span class="p">,</span> <span class="s">&#39;Task&#39;</span><span class="p">,</span> <span class="s">&#39;TaskBackend&#39;</span><span class="p">,</span> <span class="s">&#39;TaskNotAvailable&#39;</span><span class="p">,</span>
           <span class="s">&#39;nice_task_message&#39;</span><span class="p">]</span>

<span class="n">task_backends</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="s">&quot;total_seconds&quot;</span><span class="p">):</span>
    <span class="n">timedelta_seconds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>   <span class="c"># pragma    nocover</span>
    <span class="k">def</span> <span class="nf">timedelta_seconds</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span> <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">/</span> <span class="mf">10e5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="n">expiry</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expiry</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">86400</span><span class="o">*</span><span class="n">expiry</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">expiry</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span>
                <span class="mf">0.000001</span><span class="o">*</span><span class="n">expiry</span><span class="o">.</span><span class="n">microseconds</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">start</span> <span class="o">+</span> <span class="n">expiry</span>


<span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">dt</span> <span class="k">else</span> <span class="s">&#39;?&#39;</span>


<span class="k">def</span> <span class="nf">nice_task_message</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">smart_time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">smart_time</span> <span class="o">=</span> <span class="n">smart_time</span> <span class="ow">or</span> <span class="n">format_time</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">status_string</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;time_start&#39;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;time_executed&#39;</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">smart_time</span><span class="p">(</span><span class="n">ti</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> by </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="n">msg</span>


<span class="k">class</span> <span class="nc">TaskNotAvailable</span><span class="p">(</span><span class="n">PulsarException</span><span class="p">):</span>
    <span class="n">MESSAGE</span> <span class="o">=</span> <span class="s">&#39;Task {0} is not registered&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">task_name</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskNotAvailable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">TaskTimeout</span><span class="p">(</span><span class="n">PulsarException</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="TaskConsumer"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskConsumer">[docs]</a><span class="k">class</span> <span class="nc">TaskConsumer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A context manager for consuming tasks.</span>

<span class="sd">    Instances of this consumer are created by the :class:`TaskBackend` when</span>
<span class="sd">    a task is executed.</span>

<span class="sd">    .. attribute:: task_id</span>

<span class="sd">        the :attr:`Task.id` being consumed.</span>

<span class="sd">    .. attribute:: job</span>

<span class="sd">        the :ref:`Job &lt;apps-taskqueue-job&gt;` which generated the :attr:`task`.</span>

<span class="sd">    .. attribute:: worker</span>

<span class="sd">        the :class:`.Actor` running the task worker.</span>

<span class="sd">    .. attribute:: backend</span>

<span class="sd">        Access to the :class:`TaskBackend`. This is useful when creating</span>
<span class="sd">        tasks from within a :ref:`job callable &lt;job-callable&gt;`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_request_loop</span><span class="p">()</span><span class="o">.</span><span class="n">logger</span>

</div>
<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">odm</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A model containing task execution data.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;Task unique identifier.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lock_id</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">time_queued</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">time_started</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">time_ended</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;The timestamp indicating when this has finished.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">expiry</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;The timestamp indicating when this task expires.</span>

<span class="sd">    If the task is not started before this value it is ``REVOKED``.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="sd">&#39;&#39;&#39;flag indicating the :ref:`task status &lt;task-state&gt;`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">PickleField</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">PickleField</span><span class="p">()</span>

<div class="viewcode-block" id="Task.done"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.Task.done">[docs]</a>    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return ``True`` if the :class:`Task` has finshed.</span>

<span class="sd">        Its status is one of :ref:`READY_STATES &lt;task-ready-state&gt;`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">READY_STATES</span>
</div>
<div class="viewcode-block" id="Task.status_string"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.Task.status_string">[docs]</a>    <span class="k">def</span> <span class="nf">status_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A string representation of :attr:`status` code</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">states</span><span class="o">.</span><span class="n">status_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;task.</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">lazy_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">LazyString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">TaskClient</span><span class="p">(</span><span class="n">PubSubClient</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">be</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_be</span> <span class="o">=</span> <span class="n">be</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_be</span><span class="o">.</span><span class="n">event_name</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_be</span><span class="o">.</span><span class="n">fire_event</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>


<div class="viewcode-block" id="TaskBackend"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend">[docs]</a><span class="k">class</span> <span class="nc">TaskBackend</span><span class="p">(</span><span class="n">EventHandler</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A backend class for running :class:`.Task`.</span>
<span class="sd">    A :class:`TaskBackend` is responsible for creating tasks and put them</span>
<span class="sd">    into the distributed queue.</span>
<span class="sd">    It also schedules the run of periodic tasks if enabled to do so.</span>

<span class="sd">    .. attribute:: task_paths</span>

<span class="sd">        List of paths where to upload :ref:`jobs &lt;app-taskqueue-job&gt;` which</span>
<span class="sd">        are factory of tasks. Passed by the task-queue application</span>
<span class="sd">        :ref:`task paths setting &lt;setting-task_paths&gt;`.</span>

<span class="sd">    .. attribute:: schedule_periodic</span>

<span class="sd">        ``True`` if this :class:`TaskBackend` can schedule periodic tasks.</span>

<span class="sd">        Passed by the task-queue application</span>
<span class="sd">        :ref:`schedule-periodic setting &lt;setting-schedule_periodic&gt;`.</span>

<span class="sd">    .. attribute:: backlog</span>

<span class="sd">        The maximum number of concurrent tasks running on a task-queue</span>
<span class="sd">        for an :class:`.Actor`. A number in the order of 5 to 10 is normally</span>
<span class="sd">        used. Passed by the task-queue application</span>
<span class="sd">        :ref:`concurrent tasks setting &lt;setting-concurrent_tasks&gt;`.</span>

<span class="sd">    .. attribute:: max_tasks</span>

<span class="sd">        The maximum number of tasks a worker will process before restarting.</span>
<span class="sd">        Passed by the task-queue application</span>
<span class="sd">        :ref:`max requests setting &lt;setting-max_requests&gt;`.</span>

<span class="sd">    .. attribute:: poll_timeout</span>

<span class="sd">        The (asynchronous) timeout for polling tasks from the task queue.</span>

<span class="sd">        It is always a positive number and it can be specified via the</span>
<span class="sd">        backend connection string::</span>

<span class="sd">            local://?poll_timeout=3</span>

<span class="sd">        There shouldn&#39;t be any reason to modify the default value.</span>

<span class="sd">        Default: ``2``.</span>

<span class="sd">    .. attribute:: processed</span>

<span class="sd">        The number of tasks processed (so far) by the worker running this</span>
<span class="sd">        backend.</span>
<span class="sd">        This value is important in connection with the :attr:`max_tasks`</span>
<span class="sd">        attribute.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">task_poller</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">schedule_periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_tasks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">poll_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_paths</span> <span class="o">=</span> <span class="n">task_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">backlog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tasks</span> <span class="o">=</span> <span class="n">max_tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">poll_timeout</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_periodic</span> <span class="o">=</span> <span class="n">schedule_periodic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">Mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Task</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskBackend</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span>
                                          <span class="n">many_times_events</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;task_queued&#39;</span><span class="p">,</span>
                                                             <span class="s">&#39;task_started&#39;</span><span class="p">,</span>
                                                             <span class="s">&#39;task_done&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_periodic</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;task scheduler </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">dns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;task consumer </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">dns</span>
    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Eventloop running this task backend&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">_loop</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="TaskBackend.num_concurrent_tasks"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.num_concurrent_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">num_concurrent_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The number of :attr:`concurrent_tasks`.</span>

<span class="sd">        This number is never greater than the :attr:`backlog` attribute.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="p">)</span>
</div>
    <span class="nd">@lazyproperty</span>
    <span class="k">def</span> <span class="nf">entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_schedule</span><span class="p">()</span>

    <span class="nd">@lazyproperty</span>
<div class="viewcode-block" id="TaskBackend.registry"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.registry">[docs]</a>    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The :class:`.JobRegistry` for this backend.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">JobRegistry</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_paths</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaskBackend.channel"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.channel">[docs]</a>    <span class="k">def</span> <span class="nf">channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given an event ``name`` returns the corresponding channel name.</span>

<span class="sd">        The event ``name`` is one of ``task_queued``, ``task_started``</span>
<span class="sd">        or ``task_done``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">event_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">channel</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="nd">@task</span>
<div class="viewcode-block" id="TaskBackend.queue_task"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.queue_task">[docs]</a>    <span class="k">def</span> <span class="nf">queue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">meta_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Try to queue a new :ref:`Task`.</span>

<span class="sd">        This method returns a :class:`.Future` which results in the</span>
<span class="sd">        task ``id`` created. If ``jobname`` is not a valid</span>
<span class="sd">        :attr:`.Job.name`, a ``TaskNotAvailable`` exception occurs.</span>

<span class="sd">        :param jobname: the name of a :class:`.Job`</span>
<span class="sd">            registered with the :class:`.TaskQueue` application.</span>
<span class="sd">        :param meta_params: Additional parameters to be passed to the</span>
<span class="sd">            :class:`Task` constructor (not its callable function).</span>
<span class="sd">        :param expiry: optional expiry timestamp to override the default</span>
<span class="sd">            expiry of a task.</span>
<span class="sd">        :param kwargs: optional dictionary used for the key-valued arguments</span>
<span class="sd">            in the task callable.</span>
<span class="sd">        :return: a :class:`.Future` resulting in a task id on success.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pubsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jobname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">jobname</span><span class="p">]</span>
            <span class="n">task_id</span><span class="p">,</span> <span class="n">lock_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_task_ids</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">queued</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expiry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="n">get_time</span><span class="p">(</span><span class="n">expiry</span><span class="p">,</span> <span class="n">queued</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="n">get_time</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">queued</span><span class="p">)</span>
            <span class="n">meta_params</span> <span class="o">=</span> <span class="n">meta_params</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span> <span class="n">lock_id</span><span class="o">=</span><span class="n">lock_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">time_queued</span><span class="o">=</span><span class="n">queued</span><span class="p">,</span> <span class="n">expiry</span><span class="o">=</span><span class="n">expiry</span><span class="p">,</span>
                                    <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">meta_params</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_params</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_queue_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
                <span class="n">pubsub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;task_queued&#39;</span><span class="p">),</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">scheduled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scheduled</span><span class="p">:</span>
                    <span class="n">scheduled</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;queued </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">lazy_info</span><span class="p">())</span>
                <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot queue new task. Locked&#39;</span><span class="p">,</span> <span class="n">jobname</span><span class="p">)</span>
                <span class="n">coroutine_return</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TaskNotAvailable</span><span class="p">(</span><span class="n">jobname</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TaskBackend.wait_for_task"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.wait_for_task">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Asynchronously wait for a task with ``task_id`` to have finished</span>
<span class="sd">        its execution.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># make sure pubsub is implemented</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_</span><span class="p">():</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
                <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>  <span class="c"># task done, simply return it</span>
                    <span class="n">when_done</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">when_done</span><span class="p">:</span>
                        <span class="n">when_done</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">when_done</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">when_done</span><span class="p">:</span>
                        <span class="c"># No deferred, create one</span>
                        <span class="n">callbacks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">when_done</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">when_done</span>
                <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">fut</span> <span class="o">=</span> <span class="n">async</span><span class="p">(</span><span class="n">_</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">future_timeout</span><span class="p">(</span><span class="n">fut</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fut</span>
</div>
    <span class="k">def</span> <span class="nf">get_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c">########################################################################</span>
    <span class="c">##    ABSTRACT METHODS</span>
    <span class="c">########################################################################</span>
<div class="viewcode-block" id="TaskBackend.maybe_queue_task"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.maybe_queue_task">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_queue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Actually queue a ``task`` if possible.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="TaskBackend.get_task"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.get_task">[docs]</a>    <span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when_done</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Asynchronously retrieve a :class:`Task` from a ``task_id``.</span>

<span class="sd">        :param task_id: the ``id`` of the task to retrieve.</span>
<span class="sd">        :param when_done: if ``True`` return only when the task is in a</span>
<span class="sd">            ready state.</span>
<span class="sd">        :return: a :class:`Task` or ``None``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
    <span class="k">def</span> <span class="nf">finish_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">lock_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="TaskBackend.pubsub"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.pubsub">[docs]</a>    <span class="k">def</span> <span class="nf">pubsub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The publish/subscribe handler.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="TaskBackend.flush"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove all queued :class:`.Task`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c">########################################################################</span>
    <span class="c">##    START/CLOSE METHODS FOR TASK WORKERS</span>
    <span class="c">########################################################################</span></div>
<div class="viewcode-block" id="TaskBackend.start"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;invoked by the task queue ``worker`` when it starts.</span>

<span class="sd">        The ``worker`` registers the</span>
<span class="sd">        :meth:`may_pool_task` callback in its event loop.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_poller</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_poller</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">may_pool_task</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;started polling tasks&#39;</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span>
</div>
<div class="viewcode-block" id="TaskBackend.close"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Close this :class:`TaskBackend`.</span>

<span class="sd">        Invoked by the :class:`.Actor` when stopping.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_poller</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_poller</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_poller</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;stopped polling tasks&#39;</span><span class="p">)</span>
            <span class="c">#self.pubsub.close()</span>
            <span class="c">#self.store.close()</span>
</div>
<div class="viewcode-block" id="TaskBackend.generate_task_ids"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.TaskBackend.generate_task_ids">[docs]</a>    <span class="k">def</span> <span class="nf">generate_task_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;An internal method to generate task unique identifiers.</span>

<span class="sd">        :parameter job: The :class:`.Job` creating the task.</span>
<span class="sd">        :parameter kwargs: dictionary of key-valued parameters passed to the</span>
<span class="sd">            :ref:`job callable &lt;job-callable&gt;` method.</span>
<span class="sd">        :return: a two-elements tuple containing the unique id and an</span>
<span class="sd">            identifier for overlapping tasks if the :attr:`can_overlap`</span>
<span class="sd">            results in ``False``.</span>

<span class="sd">        Called by the :ref:`TaskBackend &lt;apps-taskqueue-backend&gt;` when</span>
<span class="sd">        creating a new task.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">can_overlap</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">can_overlap</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">can_overlap</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="n">can_overlap</span> <span class="o">=</span> <span class="n">can_overlap</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">create_id</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">can_overlap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tid</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kw</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">return</span> <span class="n">tid</span><span class="p">,</span> <span class="n">sha1</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c">########################################################################</span>
    <span class="c">##    PRIVATE METHODS</span>
    <span class="c">########################################################################</span></div>
    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c">#Run a tick, that is one iteration of the scheduler.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_periodic</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">remaining_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
            <span class="n">is_due</span><span class="p">,</span> <span class="n">next_time_to_run</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_due</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_due</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue_task</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_time_to_run</span><span class="p">:</span>
                <span class="n">remaining_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_time_to_run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="n">now</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">remaining_times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining_times</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">job_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span>
        <span class="n">jobnames</span> <span class="o">=</span> <span class="n">jobnames</span> <span class="ow">or</span> <span class="n">registry</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">jobnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">can_overlap</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">can_overlap</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">can_overlap</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
                <span class="n">can_overlap</span> <span class="o">=</span> <span class="s">&#39;maybe&#39;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span>
                 <span class="s">&#39;doc_syntax&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">doc_syntax</span><span class="p">,</span>
                 <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                 <span class="s">&#39;can_overlap&#39;</span><span class="p">:</span> <span class="n">can_overlap</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">next_time_to_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_scheduled</span><span class="p">((</span><span class="n">name</span><span class="p">,))</span>
                <span class="n">run_every</span> <span class="o">=</span> <span class="mi">86400</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">run_every</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">job</span><span class="o">.</span><span class="n">run_every</span><span class="o">.</span><span class="n">seconds</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;next_run&#39;</span><span class="p">:</span> <span class="n">next_time_to_run</span><span class="p">,</span>
                          <span class="s">&#39;run_every&#39;</span><span class="p">:</span> <span class="n">run_every</span><span class="p">,</span>
                          <span class="s">&#39;runs_count&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">total_run_count</span><span class="p">})</span>
            <span class="nb">all</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">all</span>

    <span class="k">def</span> <span class="nf">next_scheduled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_periodic</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">jobnames</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">jobnames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">next_entry</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">next_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">is_due</span><span class="p">,</span> <span class="n">next_time_to_run</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_due</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_due</span><span class="p">:</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">next_entry</span> <span class="o">=</span> <span class="n">entry</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">next_time_to_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">next_time</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">next_time_to_run</span> <span class="o">&lt;</span> <span class="n">next_time</span><span class="p">:</span>
                    <span class="n">next_time</span> <span class="o">=</span> <span class="n">next_time_to_run</span>
                    <span class="n">next_entry</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="k">if</span> <span class="n">next_entry</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">next_entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">next_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">jobnames</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@task</span>
    <span class="k">def</span> <span class="nf">may_pool_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c">#Called in the ``worker`` event loop.</span>
        <span class="c">#</span>
        <span class="c"># It pools a new task if possible, and add it to the queue of</span>
        <span class="c"># tasks consumed by the ``worker`` CPU-bound thread.&#39;&#39;&#39;</span>
        <span class="n">next_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="n">executor</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">executor</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_concurrent_tasks</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">backlog</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tasks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tasks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_concurrent_tasks</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Processed </span><span class="si">%s</span><span class="s"> tasks. Restarting.&#39;</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">processed</span><span class="p">)</span>
                        <span class="n">worker</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                        <span class="n">coroutine_return</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">task</span><span class="p">:</span>    <span class="c"># Got a new task</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_task</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> concurrent requests. Cannot poll.&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">num_concurrent_tasks</span><span class="p">)</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">next_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">may_pool_task</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="c"># Asynchronous execution of a Task. This method is called</span>
        <span class="c"># on a separate thread of execution from the worker event loop thread.</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">pubsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">lock_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lock_id&#39;</span><span class="p">)</span>
        <span class="n">time_ended</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="n">consumer</span> <span class="o">=</span> <span class="n">TaskConsumer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="n">task_info</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">lazy_info</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">consumer</span><span class="o">.</span><span class="n">job</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> not in registry&#39;</span> <span class="o">%</span> <span class="n">task_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">states</span><span class="o">.</span><span class="n">STARTED</span><span class="p">:</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;expiry&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expiry</span> <span class="ow">and</span> <span class="n">time_ended</span> <span class="o">&gt;</span> <span class="n">expiry</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TaskTimeout</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;starting </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">task_info</span><span class="p">)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kwargs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">clear_update</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">STARTED</span><span class="p">,</span>
                                      <span class="n">time_started</span><span class="o">=</span><span class="n">time_ended</span><span class="p">,</span>
                                      <span class="n">worker</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">aid</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">pubsub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;task_started&#39;</span><span class="p">),</span> <span class="n">task_id</span><span class="p">)</span>
                    <span class="c"># This may block for a while</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">job</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">SUCCESS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;invalid status for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">task_info</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TaskTimeout</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> timed-out&#39;</span><span class="p">,</span> <span class="n">task_info</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">REVOKED</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;failure in </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">task_info</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">FAILURE</span>
        <span class="c">#</span>
        <span class="n">task</span><span class="o">.</span><span class="n">clear_update</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span> <span class="n">time_ended</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                          <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">lock_id</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;finished </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">task_info</span><span class="p">)</span>
        <span class="c"># publish into the task_done channel</span>
        <span class="n">pubsub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;task_done&#39;</span><span class="p">),</span> <span class="n">task_id</span><span class="p">)</span>
        <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_periodic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entries</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">filter_types</span><span class="p">(</span><span class="s">&#39;periodic&#39;</span><span class="p">):</span>
            <span class="n">every</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run_every</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">every</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">every</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">every</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">every</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Schedule </span><span class="si">%s</span><span class="s"> is not a timedelta&#39;</span> <span class="o">%</span> <span class="n">every</span><span class="p">)</span>
            <span class="n">entries</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">SchedulerEntry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">every</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">anchor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entries</span>

    <span class="k">def</span> <span class="nf">task_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Got a task_id from the ``&lt;name&gt;_task_done`` channel.</span>
        <span class="c"># Check if a ``callback`` is available in the :attr:`callbacks`</span>
        <span class="c"># dictionary. If so fire the callback with the ``task`` instance</span>
        <span class="c"># corresponsding to the input ``task_id``.</span>
        <span class="c"># If a callback is not available, it must have been fired already</span>
        <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">when_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">when_done</span><span class="p">:</span>
                <span class="n">when_done</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SchedulerEntry"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.SchedulerEntry">[docs]</a><span class="k">class</span> <span class="nc">SchedulerEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A class used as a schedule entry by the :class:`.TaskBackend`.</span>

<span class="sd">    .. attribute:: name</span>

<span class="sd">        Task name</span>

<span class="sd">    .. attribute:: run_every</span>

<span class="sd">        Interval in seconds</span>

<span class="sd">    .. attribute:: anchor</span>

<span class="sd">        Datetime anchor</span>

<span class="sd">    .. attribute:: last_run_at</span>

<span class="sd">        last run datetime</span>

<span class="sd">    .. attribute:: total_run_count</span>

<span class="sd">        Total number of times this periodic task has been executed by the</span>
<span class="sd">        :class:`.TaskBackend`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">run_every</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_every</span> <span class="o">=</span> <span class="n">run_every</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_run_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="SchedulerEntry.scheduled_last_run_at"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.SchedulerEntry.scheduled_last_run_at">[docs]</a>    <span class="k">def</span> <span class="nf">scheduled_last_run_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The scheduled last run datetime.</span>

<span class="sd">        This is different from :attr:`last_run_at` only when</span>
<span class="sd">        :attr:`anchor` is set.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">last_run_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_run_at</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span>
        <span class="k">if</span> <span class="n">last_run_at</span> <span class="ow">and</span> <span class="n">anchor</span><span class="p">:</span>
            <span class="n">run_every</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_every</span>
            <span class="n">times</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timedelta_seconds</span><span class="p">(</span><span class="n">last_run_at</span> <span class="o">-</span> <span class="n">anchor</span><span class="p">)</span>
                        <span class="o">/</span> <span class="n">timedelta_seconds</span><span class="p">(</span><span class="n">run_every</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">times</span><span class="p">:</span>
                <span class="n">anchor</span> <span class="o">+=</span> <span class="n">times</span><span class="o">*</span><span class="n">run_every</span>
                <span class="k">while</span> <span class="n">anchor</span> <span class="o">&lt;=</span> <span class="n">last_run_at</span><span class="p">:</span>
                    <span class="n">anchor</span> <span class="o">+=</span> <span class="n">run_every</span>
                <span class="k">while</span> <span class="n">anchor</span> <span class="o">&gt;</span> <span class="n">last_run_at</span><span class="p">:</span>
                    <span class="n">anchor</span> <span class="o">-=</span> <span class="n">run_every</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor</span>
            <span class="k">return</span> <span class="n">anchor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_run_at</span>
</div>
<div class="viewcode-block" id="SchedulerEntry.next"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.SchedulerEntry.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Increase the :attr:`total_run_count` attribute by one and set the</span>
<span class="sd">        value of :attr:`last_run_at` to ``now``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_at</span> <span class="o">=</span> <span class="n">now</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_run_count</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="SchedulerEntry.is_due"><a class="viewcode-back" href="../../../../apps/tasks.html#pulsar.apps.tasks.backend.SchedulerEntry.is_due">[docs]</a>    <span class="k">def</span> <span class="nf">is_due</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns tuple of two items ``(is_due, next_time_to_run)``,</span>
<span class="sd">        where next time to run is in seconds.</span>

<span class="sd">        See :meth:`unuk.contrib.tasks.models.PeriodicTask.is_due`</span>
<span class="sd">        for more information.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">last_run_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_last_run_at</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">now</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">rem_delta</span> <span class="o">=</span> <span class="n">last_run_at</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_every</span> <span class="o">-</span> <span class="n">now</span>
        <span class="n">rem</span> <span class="o">=</span> <span class="n">timedelta_seconds</span><span class="p">(</span><span class="n">rem_delta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timedelta_seconds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_every</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">rem</span>

</div></div>
<span class="k">class</span> <span class="nc">PulsarTaskBackend</span><span class="p">(</span><span class="n">TaskBackend</span><span class="p">):</span>

    <span class="nd">@lazyproperty</span>
    <span class="k">def</span> <span class="nf">store_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">client</span><span class="p">()</span>

    <span class="nd">@lazymethod</span>
    <span class="k">def</span> <span class="nf">pubsub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pubsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>
        <span class="n">pubsub</span><span class="o">.</span><span class="n">add_client</span><span class="p">(</span><span class="n">TaskClient</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c"># pubsub channels names from event names</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">))</span>
        <span class="n">pubsub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">*</span><span class="n">channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_event</span><span class="p">(</span><span class="s">&#39;task_done&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_done_callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pubsub</span>

    <span class="k">def</span> <span class="nf">maybe_queue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">free</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;lock_id&#39;</span><span class="p">]:</span>
            <span class="n">free</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;hsetnx&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="s">&#39;locks&#39;</span><span class="p">),</span>
                                       <span class="n">task</span><span class="p">[</span><span class="s">&#39;lock_id&#39;</span><span class="p">],</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">free</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;lpush&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="s">&#39;inqueue&#39;</span><span class="p">),</span> <span class="n">task</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">yield</span> <span class="n">t</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coroutine_return</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when_done</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="n">inq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;inqueue&#39;</span><span class="p">)</span>
            <span class="n">ouq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;outqueue&#39;</span><span class="p">)</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;brpoplpush&#39;</span><span class="p">,</span> <span class="n">inq</span><span class="p">,</span> <span class="n">ouq</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">poll_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task_id</span><span class="p">:</span>
                <span class="n">coroutine_return</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="n">coroutine_return</span><span class="p">(</span><span class="n">task</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">lock_id</span><span class="p">):</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lock_id</span><span class="p">:</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;locks&#39;</span><span class="p">),</span> <span class="n">lock_id</span><span class="p">)</span>
        <span class="c"># Remove the task_id from the inqueue list</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">lrem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="s">&#39;inqueue&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pipe</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_name</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">_read_store</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">pk</span><span class="p">),</span> <span class="n">factory</span><span class="o">=</span><span class="n">Task</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="n">task_backends</span><span class="p">[</span><span class="s">&#39;pulsar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PulsarTaskBackend</span>
<span class="n">task_backends</span><span class="p">[</span><span class="s">&#39;redis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PulsarTaskBackend</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="../../../../index.html">
  <img class="logo" width="200" src="../../../../static/pulsar.png" alt="pulsar" title="Pulsar"/>
</a>
</p>
<div class="g-plusone"></div>
<script type="text/javascript">
  window.___gcfg = {lang: 'en-GB'};
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<br>
<a href="https://twitter.com/share" class="twitter-share-button" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<br>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


<div class="footer">
     &copy; Copyright 2011-2014, Luca Sbardella.
   Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b1.
 </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  
  _gaq.push(['_setAccount', 'UA-3900561-8']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>