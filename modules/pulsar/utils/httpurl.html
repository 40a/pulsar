
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pulsar.utils.httpurl &mdash; pulsar v0.4.4b1 documentation</title>
    <link rel="stylesheet" href="../../../static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.4.4b1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <link rel="top" title="pulsar v0.4.4b1 documentation" href="../../../index.html" />
    <link rel="up" title="pulsar" href="../../pulsar.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pulsar v0.4.4b1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../pulsar.html" accesskey="U">pulsar</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
<div class="deck">

    
        <p class="developmentversion">
        Documentation for pulsar's DEVELOPMENT version. Get the 
        <a href="http://packages.python.org/pulsar/">release docs here</a>.
        </p>
    

</div>

      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pulsar.utils.httpurl</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;This is a substantial module which imports several classes and functions</span>
<span class="sd">from the standard library in a python 2.6 to python 3.3 compatible fashion.</span>
<span class="sd">On top of that, it implements the :class:`HttpClient` for handling synchronous</span>
<span class="sd">and asynchronous HTTP requests in a pythonic way.</span>

<span class="sd">It is a thin layer on top of urllib2 in python2 / urllib in Python 3.</span>
<span class="sd">Several opensource efforts have been used as source of snippets:</span>

<span class="sd">* http-parser_</span>
<span class="sd">* request_</span>
<span class="sd">* urllib3_</span>
<span class="sd">* werkzeug_</span>

<span class="sd">This is a long stand-alone module which can be dropped in any library and used</span>
<span class="sd">as it is.</span>

<span class="sd">Usage</span>
<span class="sd">===========</span>
<span class="sd">Making requests with the :class:`HttpClient` is simple. First you create</span>
<span class="sd">a client, which can be as simple as::</span>

<span class="sd">    &gt;&gt;&gt; client = HttpClient()</span>

<span class="sd">Then you can perform an HTTP request, for example::</span>

<span class="sd">    &gt;&gt;&gt; r = client.get(&#39;http://www.bbc.co.uk&#39;)</span>


<span class="sd">.. _http-parser: https://github.com/benoitc/http-parser</span>
<span class="sd">.. _urllib3: https://github.com/shazow/urllib3</span>
<span class="sd">.. _request: https://github.com/kennethreitz/requests</span>
<span class="sd">.. _werkzeug: https://github.com/mitsuhiko/werkzeug</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">email.utils</span> <span class="kn">import</span> <span class="n">formatdate</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="n">ispy3k</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ispy26</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

<span class="n">create_connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;httpurl&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">select</span> <span class="kn">import</span> <span class="n">poll</span><span class="p">,</span> <span class="n">POLLIN</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c">#pragma    nocover</span>
    <span class="n">poll</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">select</span> <span class="kn">import</span> <span class="n">select</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c">#pragma    nocover</span>
        <span class="n">select</span> <span class="o">=</span> <span class="bp">False</span>
        
<span class="k">try</span><span class="p">:</span>    <span class="c"># Compiled with SSL?</span>
    <span class="n">BaseSSLError</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ssl</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="kn">import</span> <span class="nn">ssl</span>
    <span class="n">BaseSSLError</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>   <span class="c"># pragma : no cover </span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">ispy3k</span><span class="p">:</span> <span class="c"># Python 3</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">urllibr</span>
    <span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">httpclient</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlsplit</span><span class="p">,</span>\
                             <span class="n">parse_qs</span><span class="p">,</span> <span class="n">parse_qsl</span><span class="p">,</span> <span class="n">splitport</span><span class="p">,</span> <span class="n">urlunparse</span><span class="p">,</span>\
                             <span class="n">urljoin</span>
    <span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">responses</span>
    <span class="kn">from</span> <span class="nn">http.cookiejar</span> <span class="kn">import</span> <span class="n">CookieJar</span><span class="p">,</span> <span class="n">Cookie</span>
    <span class="kn">from</span> <span class="nn">http.cookies</span> <span class="kn">import</span> <span class="n">SimpleCookie</span><span class="p">,</span> <span class="n">BaseCookie</span><span class="p">,</span> <span class="n">Morsel</span><span class="p">,</span> <span class="n">CookieError</span>

    <span class="n">string_type</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">getproxies_environment</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">getproxies_environment</span>
    <span class="n">ascii_letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="nb">zip</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="nb">chr</span> <span class="o">=</span> <span class="nb">chr</span>
    <span class="n">iteritems</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span> <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="n">itervalues</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span> <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">is_string</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">is_string_or_native_string</span> <span class="o">=</span> <span class="n">is_string</span>

    <span class="k">def</span> <span class="nf">to_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span> <span class="ow">or</span> <span class="s">&#39;strict&#39;</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s">&#39;utf-8&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inverse of to_bytes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">native_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">force_native_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

<span class="k">else</span><span class="p">:</span>   <span class="c"># pragma : no cover</span>
    <span class="kn">import</span> <span class="nn">urllib2</span> <span class="kn">as</span> <span class="nn">urllibr</span>
    <span class="kn">import</span> <span class="nn">httplib</span> <span class="kn">as</span> <span class="nn">httpclient</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">getproxies_environment</span><span class="p">,</span>\
                        <span class="n">splitport</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">parse_qs</span><span class="p">,</span> <span class="n">urlunparse</span><span class="p">,</span> <span class="n">urljoin</span><span class="p">,</span>\
                         <span class="n">parse_qsl</span>
    <span class="kn">from</span> <span class="nn">httplib</span> <span class="kn">import</span> <span class="n">responses</span>
    <span class="kn">from</span> <span class="nn">cookielib</span> <span class="kn">import</span> <span class="n">CookieJar</span><span class="p">,</span> <span class="n">Cookie</span>
    <span class="kn">from</span> <span class="nn">Cookie</span> <span class="kn">import</span> <span class="n">SimpleCookie</span><span class="p">,</span> <span class="n">BaseCookie</span><span class="p">,</span> <span class="n">Morsel</span><span class="p">,</span> <span class="n">CookieError</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span> <span class="k">as</span> <span class="nb">zip</span><span class="p">,</span> <span class="n">imap</span> <span class="k">as</span> <span class="nb">map</span>

    <span class="n">string_type</span> <span class="o">=</span> <span class="nb">unicode</span>
    <span class="n">ascii_letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">letters</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="nb">xrange</span>
    <span class="nb">chr</span> <span class="o">=</span> <span class="nb">unichr</span>
    <span class="n">iteritems</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span> <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
    <span class="n">itervalues</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span> <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>
    <span class="n">is_string</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)</span>
    <span class="n">is_string_or_native_string</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">,</span>
                              <span class="n">source_address</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Form Python 2.7&quot;&quot;&quot;</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">address</span>
            <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
                <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">socket</span><span class="o">.</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">:</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">source_address</span><span class="p">:</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">source_address</span><span class="p">)</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">sock</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">_</span>
                    <span class="k">if</span> <span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;getaddrinfo returns an empty list&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">to_bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s">&#39;utf-8&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inverse of to_bytes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">native_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">force_native_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

<span class="n">HTTPError</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">HTTPError</span>
<span class="n">URLError</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">URLError</span>
<span class="n">request_host</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">request_host</span>
<span class="n">parse_http_list</span> <span class="o">=</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">parse_http_list</span>

<span class="k">class</span> <span class="nc">SSLError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="s">&quot;Raised when SSL certificate fails in an HTTPS connection.&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">HTTPurlError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">TooManyRedirects</span><span class="p">(</span><span class="n">HTTPurlError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">mapping_iterator</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iterable</span>

<span class="c">####################################################    URI &amp; IRI SUFF</span>
<span class="c">#</span>
<span class="c"># The reserved URI characters (RFC 3986 - section 2.2)</span>
<span class="c">#Default is charset is &quot;iso-8859-1&quot; (latin-1) from section 3.7.1</span>
<span class="c">#http://www.ietf.org/rfc/rfc2616.txt</span>
<span class="n">DEFAULT_CHARSET</span> <span class="o">=</span> <span class="s">&#39;iso-8859-1&#39;</span>
<span class="n">URI_GEN_DELIMS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s">&#39;:/?#[]@&#39;</span><span class="p">)</span>
<span class="n">URI_SUB_DELIMS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s">&quot;!$&amp;&#39;()*+,;=&quot;</span><span class="p">)</span>
<span class="n">URI_RESERVED_SET</span> <span class="o">=</span> <span class="n">URI_GEN_DELIMS</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">URI_SUB_DELIMS</span><span class="p">)</span>
<span class="n">URI_RESERVED_CHARS</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">URI_RESERVED_SET</span><span class="p">)</span>
<span class="c"># The unreserved URI characters (RFC 3986 - section 2.3)</span>
<span class="n">URI_UNRESERVED_SET</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s">&#39;-._~&#39;</span><span class="p">)</span>
<span class="n">URI_SAFE_CHARS</span> <span class="o">=</span> <span class="n">URI_RESERVED_CHARS</span> <span class="o">+</span> <span class="s">&#39;%~&#39;</span>
<span class="n">HEADER_TOKEN_CHARS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s">&quot;!#$%&amp;&#39;*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
                               <span class="s">&#39;^_`abcdefghijklmnopqrstuvwxyz|~&#39;</span><span class="p">)</span>

<span class="n">escape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">quote</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s">&#39;~&#39;</span><span class="p">)</span>
<span class="n">urlquote</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">iri</span><span class="p">:</span> <span class="n">quote</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="n">URI_RESERVED_CHARS</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gen_unquote</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="n">unreserved_set</span> <span class="o">=</span> <span class="n">URI_UNRESERVED_SET</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">force_native_str</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">part</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unreserved_set</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">c</span> <span class="o">+</span> <span class="n">part</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s">&#39;%&#39;</span> <span class="o">+</span> <span class="n">part</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s">&#39;%&#39;</span> <span class="o">+</span> <span class="n">part</span>
                
<span class="k">def</span> <span class="nf">unquote_unreserved</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Un-escape any percent-escape sequences in a URI that are unreserved</span>
<span class="sd">characters. This leaves all reserved, illegal and non-ASCII bytes encoded.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_gen_unquote</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">requote_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Re-quote the given URI.</span>

<span class="sd">    This function passes the given URI through an unquote/quote cycle to</span>
<span class="sd">    ensure that it is fully and consistently quoted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Unquote only the unreserved characters</span>
    <span class="c"># Then quote only illegal characters (do not quote reserved, unreserved,</span>
    <span class="c"># or &#39;%&#39;)</span>
    <span class="k">return</span> <span class="n">quote</span><span class="p">(</span><span class="n">unquote_unreserved</span><span class="p">(</span><span class="n">uri</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="n">URI_SAFE_CHARS</span><span class="p">)</span>

<div class="viewcode-block" id="iri_to_uri"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.iri_to_uri">[docs]</a><span class="k">def</span> <span class="nf">iri_to_uri</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert an Internationalized Resource Identifier (IRI) portion to a URI</span>
<span class="sd">portion that is suitable for inclusion in a URL.</span>
<span class="sd">This is the algorithm from section 3.1 of RFC 3987.</span>
<span class="sd">Returns an ASCII native string containing the encoded result.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">iri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iri</span>
    <span class="n">iri</span> <span class="o">=</span> <span class="n">force_native_str</span><span class="p">(</span><span class="n">iri</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">iri</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">?</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">iri</span><span class="p">,</span><span class="s">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kv</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">urlquote</span><span class="p">(</span><span class="n">unquote_unreserved</span><span class="p">(</span><span class="n">iri</span><span class="p">))</span>
</div>
<span class="k">def</span> <span class="nf">host_and_port</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="k">if</span> <span class="n">port</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">host_and_port_default</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;http&quot;</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s">&#39;80&#39;</span>
        <span class="k">elif</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;https&quot;</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s">&#39;443&#39;</span>
    <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span>

<span class="k">def</span> <span class="nf">remove_double_slash</span><span class="p">(</span><span class="n">route</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;//&#39;</span> <span class="ow">in</span> <span class="n">route</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;/+&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">route</span>

<span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>    <span class="c">#pragma nocover</span>
    <span class="sd">&quot;&quot;&quot;Check if socket is connected.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">poll</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">select</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">select</span><span class="p">([</span><span class="n">sock</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="c"># This version is better on platforms that support it.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">poll</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">POLLIN</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">fno</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fno</span> <span class="o">==</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">():</span>
                <span class="c"># Either data is buffered (bad), or the connection is dropped.</span>
                <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="c">####################################################    REQUEST METHODS</span>
<span class="n">ENCODE_URL_METHODS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s">&#39;OPTIONS&#39;</span><span class="p">])</span>
<span class="n">ENCODE_BODY_METHODS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s">&#39;PATCH&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;PUT&#39;</span><span class="p">,</span> <span class="s">&#39;TRACE&#39;</span><span class="p">])</span>
<span class="n">REDIRECT_CODES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>

<div class="viewcode-block" id="has_empty_content"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.has_empty_content">[docs]</a><span class="k">def</span> <span class="nf">has_empty_content</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;204, 304 and 1xx codes have no content&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NO_CONTENT</span> <span class="ow">or</span>\
            <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NOT_MODIFIED</span> <span class="ow">or</span>\
            <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span>\
            <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<span class="k">def</span> <span class="nf">is_succesful</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;2xx status is succesful&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">300</span>

<span class="c">####################################################    HTTP HEADERS</span>
<span class="n">WEBSOCKET_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="n">HEADER_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;general&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&#39;Date&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Pragma&#39;</span><span class="p">,</span> <span class="s">&#39;Trailer&#39;</span><span class="p">,</span><span class="s">&#39;Transfer-Encoding&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s">&#39;Sec-WebSocket-Extensions&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Sec-WebSocket-Protocol&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Via&#39;</span><span class="p">,</span><span class="s">&#39;Warning&#39;</span><span class="p">)),</span>
                 <span class="c"># The request-header fields allow the client to pass additional</span>
                 <span class="c"># information about the request, and about the client itself,</span>
                 <span class="c"># to the server.</span>
                 <span class="s">&#39;request&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;Accept&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Charset&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Language&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Authorization&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Cookie&#39;</span><span class="p">,</span> <span class="s">&#39;Expect&#39;</span><span class="p">,</span> <span class="s">&#39;From&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Host&#39;</span><span class="p">,</span> <span class="s">&#39;If-Match&#39;</span><span class="p">,</span> <span class="s">&#39;If-Modified-Since&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;If-None-Match&#39;</span><span class="p">,</span> <span class="s">&#39;If-Range&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;If-Unmodified-Since&#39;</span><span class="p">,</span> <span class="s">&#39;Max-Forwards&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Proxy-Authorization&#39;</span><span class="p">,</span> <span class="s">&#39;Range&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Referer&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Sec-WebSocket-Key&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;Sec-WebSocket-Version&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;TE&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;User-Agent&#39;</span><span class="p">,</span>
                                       <span class="s">&#39;X-Requested-With&#39;</span><span class="p">)),</span>
                 <span class="c"># The response-header fields allow the server to pass</span>
                 <span class="c"># additional information about the response which cannot be</span>
                 <span class="c"># placed in the Status- Line.</span>
                 <span class="s">&#39;response&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;Accept-Ranges&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Age&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;ETag&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Location&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Proxy-Authenticate&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Retry-After&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Sec-WebSocket-Accept&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Server&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Set-Cookie2&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;Vary&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;X-Frame-Options&#39;</span><span class="p">)),</span>
                 <span class="s">&#39;entity&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;Allow&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Encoding&#39;</span><span class="p">,</span>
                                      <span class="s">&#39;Content-Language&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Length&#39;</span><span class="p">,</span>
                                      <span class="s">&#39;Content-Location&#39;</span><span class="p">,</span> <span class="s">&#39;Content-MD5&#39;</span><span class="p">,</span>
                                      <span class="s">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span>
                                      <span class="s">&#39;Expires&#39;</span><span class="p">,</span> <span class="s">&#39;Last-Modified&#39;</span><span class="p">))}</span>

<span class="n">CLIENT_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;entity&#39;</span><span class="p">],</span>
                                                      <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;request&#39;</span><span class="p">])</span>
<span class="n">SERVER_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;entity&#39;</span><span class="p">],</span>
                                                      <span class="n">HEADER_FIELDS</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">])</span>
<span class="n">ALL_HEADER_FIELDS</span> <span class="o">=</span> <span class="n">CLIENT_HEADER_FIELDS</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">SERVER_HEADER_FIELDS</span><span class="p">)</span>
<span class="n">ALL_HEADER_FIELDS_DICT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ALL_HEADER_FIELDS</span><span class="p">))</span>

<span class="n">TYPE_HEADER_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;client&#39;</span><span class="p">:</span> <span class="n">CLIENT_HEADER_FIELDS</span><span class="p">,</span>
                      <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="n">SERVER_HEADER_FIELDS</span><span class="p">,</span>
                      <span class="s">&#39;both&#39;</span><span class="p">:</span> <span class="n">ALL_HEADER_FIELDS</span><span class="p">}</span>

<span class="n">header_type</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;client&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;both&#39;</span><span class="p">}</span>
<span class="n">header_type_to_int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">header_type</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">capfirst</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    
<span class="k">def</span> <span class="nf">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">capfirst</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">b</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">header_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">HEADERS_SET</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;x-&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ALL_HEADER_FIELDS_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">HEADERS_SET</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span> <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">HEADERS_SET</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">header</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">capheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">quote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">extra_chars</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_token</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quote a header value if necessary.</span>

<span class="sd">:param value: the value to quote.</span>
<span class="sd">:param extra_chars: a list of extra characters to skip quoting.</span>
<span class="sd">:param allow_token: if this is enabled token values are returned</span>
<span class="sd">                    unchanged.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">force_native_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_token</span><span class="p">:</span>
        <span class="n">token_chars</span> <span class="o">=</span> <span class="n">HEADER_TOKEN_CHARS</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra_chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">token_chars</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unquote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_filename</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unquotes a header value. Reversal of :func:`quote_header_value`.</span>
<span class="sd">This does not use the real unquoting but what browsers are actually</span>
<span class="sd">using for quoting.</span>
<span class="sd">:param value: the header value to unquote.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
        <span class="c"># this is not the real unquoting, but fixing this so that the</span>
        <span class="c"># RFC is met will result in bugs with internet explorer and</span>
        <span class="c"># probably some other browsers as well.  IE for example is</span>
        <span class="c"># uploading files with &quot;C:\foo\bar.txt&quot; as filename</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># if this is a filename and the starting characters look like</span>
        <span class="c"># a UNC path, then just return the value without quotes.  Using the</span>
        <span class="c"># replace sequence below on a UNC path has the effect of turning</span>
        <span class="c"># the leading double slash into a single slash and then</span>
        <span class="c"># _fix_ie_filename() doesn&#39;t work correctly.  See #458.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_filename</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">parse_dict_header</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse lists of key, value pairs as described by RFC 2068 Section 2 and</span>
<span class="sd">    convert them into a python dict:</span>

<span class="sd">    &gt;&gt;&gt; d = parse_dict_header(&#39;foo=&quot;is a fish&quot;, bar=&quot;as well&quot;&#39;)</span>
<span class="sd">    &gt;&gt;&gt; type(d) is dict</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; sorted(d.items())</span>
<span class="sd">    [(&#39;bar&#39;, &#39;as well&#39;), (&#39;foo&#39;, &#39;is a fish&#39;)]</span>

<span class="sd">    If there is no value for a key it will be `None`:</span>

<span class="sd">    &gt;&gt;&gt; parse_dict_header(&#39;key_without_value&#39;)</span>
<span class="sd">    {&#39;key_without_value&#39;: None}</span>

<span class="sd">    To create a header from the :class:`dict` again, use the</span>
<span class="sd">    :func:`dump_header` function.</span>

<span class="sd">    :param value: a string with a dict header.</span>
<span class="sd">    :return: :class:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parse_http_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;=&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">continue</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unquote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Headers"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers">[docs]</a><span class="k">class</span> <span class="nc">Headers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Utility for managing HTTP headers for both clients and servers.</span>
<span class="sd">It has a dictionary like interface</span>
<span class="sd">with few extra functions to facilitate the insertion of multiple values.</span>

<span class="sd">From http://www.w3.org/Protocols/rfc2616/rfc2616.html</span>

<span class="sd">Section 4.2</span>
<span class="sd">The order in which header fields with differing field names are received is not</span>
<span class="sd">significant. However, it is &quot;good practice&quot; to send general-header fields first,</span>
<span class="sd">followed by request-header or response-header fields, and ending with</span>
<span class="sd">the entity-header fields.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">header_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span> <span class="o">=</span> <span class="n">TYPE_HEADER_FIELDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;both&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span> <span class="o">=</span> <span class="n">TYPE_HEADER_FIELDS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ordered</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.as_dict"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert this :class:`Headers` into a dictionary.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)))</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">header_type_to_int</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.update"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extend the headers with a dictionary or an iterable yielding keys</span>
<span class="sd">and values.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</div>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.getheaders"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers.getheaders">[docs]</a>    <span class="k">def</span> <span class="nf">getheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Required by cookielib. If the key is not available,</span>
<span class="sd">it returns an empty list.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="p">[])</span>
</div>
    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Headers.add_header"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers.add_header">[docs]</a>    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add *value* to *key* header. If the header is already available,</span>
<span class="sd">append the value to the list.&#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
</div>
<div class="viewcode-block" id="Headers.flat"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.Headers.flat">[docs]</a>    <span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    	<span class="sd">&#39;&#39;&#39;Full headers bytes representation&#39;&#39;&#39;</span>
    	<span class="n">vs</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    	<span class="k">return</span> <span class="p">(</span><span class="s">&#39;HTTP/</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">vs</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hf</span> <span class="o">=</span> <span class="n">HEADER_FIELDS</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;general&#39;</span><span class="p">,[]),</span> <span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">,[]),</span> <span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,[]),</span> <span class="p">(</span><span class="s">&#39;entity&#39;</span><span class="p">,[]))</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">yield</span> <span class="s">&#39;&#39;</span>
        <span class="k">yield</span> <span class="s">&#39;&#39;</span>


<span class="c">###############################################################################</span>
<span class="c">##    HTTP PARSER</span>
<span class="c">###############################################################################</span></div>
<span class="n">METHOD_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;[A-Z0-9$-_.]{3,20}&quot;</span><span class="p">)</span>
<span class="n">VERSION_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;HTTP/(\d+).(\d+)&quot;</span><span class="p">)</span>
<span class="n">STATUS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;(\d{3})\s*(\w*)&quot;</span><span class="p">)</span>
<span class="n">HEADER_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;[</span><span class="se">\x00</span><span class="s">-</span><span class="se">\x1F\x7F</span><span class="s">()&lt;&gt;@,;:\[\]={} </span><span class="se">\t\\\\\&quot;</span><span class="s">]&quot;</span><span class="p">)</span>

<span class="c"># errors</span>
<span class="n">BAD_FIRST_LINE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">INVALID_HEADER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">INVALID_CHUNK</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span> <span class="nc">InvalidRequestLine</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised when first line is invalid &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">InvalidHeader</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised on invalid header &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">InvalidChunkSize</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; error raised when we parse an invalid chunk size &quot;&quot;&quot;</span>


<div class="viewcode-block" id="HttpParser"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser">[docs]</a><span class="k">class</span> <span class="nc">HttpParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A python HTTP parser.</span>

<span class="sd">Original code from https://github.com/benoitc/http-parser</span>

<span class="sd">2011 (c) Benoit Chesneau &lt;benoitc@e-engura.org&gt;</span>

<span class="sd">Permission is hereby granted, free of charge, to any person</span>
<span class="sd">obtaining a copy of this software and associated documentation</span>
<span class="sd">files (the &quot;Software&quot;), to deal in the Software without</span>
<span class="sd">restriction, including without limitation the rights to use,</span>
<span class="sd">copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="sd">copies of the Software, and to permit persons to whom the</span>
<span class="sd">Software is furnished to do so, subject to the following</span>
<span class="sd">conditions:</span>

<span class="sd">The above copyright notice and this permission notice shall be</span>
<span class="sd">included in all copies or substantial portions of the Software.</span>

<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="sd">EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</span>
<span class="sd">OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="sd">NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span>
<span class="sd">HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="sd">WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="sd">FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="sd">OTHER DEALINGS IN THE SOFTWARE.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">decompress</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span> <span class="o">=</span> <span class="n">decompress</span>
        <span class="c"># errors vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c"># protected variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_protocol</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span><span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trailers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># private events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">kind_number</span>

    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="k">def</span> <span class="nf">get_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span>

    <span class="k">def</span> <span class="nf">get_status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>

    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="k">def</span> <span class="nf">get_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span>

    <span class="k">def</span> <span class="nf">get_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span>

    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

    <span class="k">def</span> <span class="nf">get_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_protocol</span>

    <span class="k">def</span> <span class="nf">get_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body</span>

<div class="viewcode-block" id="HttpParser.recv_body"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.recv_body">[docs]</a>    <span class="k">def</span> <span class="nf">recv_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return last chunk of the parsed body&quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">body</span>
</div>
<div class="viewcode-block" id="HttpParser.is_headers_complete"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.is_headers_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_headers_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if all headers have been parsed. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span>
</div>
<div class="viewcode-block" id="HttpParser.is_partial_body"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.is_partial_body">[docs]</a>    <span class="k">def</span> <span class="nf">is_partial_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if a chunk of body have been parsed &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span>
</div>
<div class="viewcode-block" id="HttpParser.is_message_begin"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.is_message_begin">[docs]</a>    <span class="k">def</span> <span class="nf">is_message_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if the parsing start &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span>
</div>
<div class="viewcode-block" id="HttpParser.is_message_complete"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.is_message_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_message_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if the parsing is done (we get EOF) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span>
</div>
<div class="viewcode-block" id="HttpParser.is_chunked"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpParser.is_chunked">[docs]</a>    <span class="k">def</span> <span class="nf">is_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return True if Transfer-Encoding header value is chunked&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span>
</div>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="c"># end of body can be passed manually by putting a length of 0</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c"># start to parse</span>
        <span class="n">nb_parsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">first_line</span> <span class="o">=</span> <span class="n">native_str</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">),</span><span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
                    <span class="n">rest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_firstline</span><span class="p">(</span><span class="n">first_line</span><span class="p">):</span>
                        <span class="n">nb_parsed</span> <span class="o">=</span> <span class="n">nb_parsed</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">nb_parsed</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">to_parse</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">to_parse</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">to_parse</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">length</span>
                    <span class="n">nb_parsed</span> <span class="o">=</span> <span class="n">nb_parsed</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_parse</span><span class="p">)</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidHeader</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">INVALID_HEADER</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">nb_parsed</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">length</span>
                <span class="k">elif</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret</span>
                <span class="k">elif</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">return</span> <span class="n">length</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nb_parsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_begin</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__on_firstline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">length</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_parse_firstline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c"># auto detect</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_request_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidRequestLine</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_request_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidRequestLine</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">BAD_FIRST_LINE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_parse_response_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c"># version</span>
        <span class="n">matchv</span> <span class="o">=</span> <span class="n">VERSION_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">matchv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s">&quot;Invalid HTTP version: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matchv</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchv</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c"># status</span>
        <span class="n">matchs</span> <span class="o">=</span> <span class="n">STATUS_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">matchs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s">&quot;Invalid status %&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchs</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">matchs</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_request_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c"># Method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">METHOD_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s">&quot;invalid Method: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c"># URI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_string</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragment</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">fragment</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_protocol</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c"># Version</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">VERSION_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestLine</span><span class="p">(</span><span class="s">&quot;Invalid HTTP version: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_parse_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># we don&#39;t have all headers</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">native_str</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
        <span class="c"># Split lines on \r\n keeping the \r\n on each line</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">deque</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)))</span>
        <span class="c"># Parse headers into key/value pairs paying attention</span>
        <span class="c"># to continuation lines.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="c"># Parse initial header name : value pair.</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">HEADER_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidHeader</span><span class="p">(</span><span class="s">&quot;invalid header name </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()]</span>
            <span class="c"># Consume value continuation lines</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="c"># multiple headers</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="c"># store new header value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c"># detect now if body is sent by chunks.</span>
        <span class="n">clen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content-length&#39;</span><span class="p">)</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;transfer-encoding&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="p">(</span><span class="n">te</span> <span class="o">==</span> <span class="s">&#39;chunked&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">clen</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">clen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># ignore nonsensical negative lengths</span>
                    <span class="n">clen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NO_CONTENT</span> <span class="ow">or</span>
            <span class="n">status</span> <span class="o">==</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">NOT_MODIFIED</span> <span class="ow">or</span>
            <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span>      <span class="c"># 1xx codes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span><span class="p">):</span>
            <span class="n">clen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen</span> <span class="o">=</span> <span class="n">clen</span>
        <span class="c"># detect encoding and set decompress object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content-encoding&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">&quot;gzip&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="mi">16</span><span class="o">+</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">&quot;deflate&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">()</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__on_headers_complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c"># maybe decompress</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clen_rest</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__on_message_complete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">size</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_chunk_size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidChunkSize</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">INVALID_CHUNK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;invalid chunk size [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">body_part</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[:</span><span class="n">size</span><span class="p">],</span> <span class="n">rest</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errno</span> <span class="o">=</span> <span class="n">INVALID_CHUNK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;chunk missing terminator [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">data</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c"># maybe decompress</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">body_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__decompress_obj</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial_body</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body_part</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">rest</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_chunk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">rest_chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidChunkSize</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_trailers</span><span class="p">(</span><span class="n">rest_chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">rest_chunk</span>

    <span class="k">def</span> <span class="nf">_parse_trailers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trailers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_headers</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">idx</span><span class="p">])</span>


<span class="c">################################################################################</span>
<span class="c">##    HTTP CLIENT</span>
<span class="c">################################################################################</span></div>
<span class="k">class</span> <span class="nc">HttpConnectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">IOClientRead</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Base class for IO clients which keep reading from a socket until a</span>
<span class="sd">full parsed message is available.</span>

<span class="sd">.. attribute:: async</span>

<span class="sd">    True if the socket is asynchronous</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">parsedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function is called once data is available on the socket.</span>
<span class="sd">If the parser is expecting more data, it should return ``None`` so that</span>
<span class="sd">this :class:`IOClientRead` can submit another read request.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read data from the socket&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="c">## INTERNALS</span>
    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_got_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsedata</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Cannot read. Asynchronous socket is closed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Read from a blocking socket</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">DEFAULT_BUFFER_SIZE</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="c"># No data. the socket is closed.</span>
                    <span class="c"># We raise socket.error</span>
                    <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No data received. Socket is closed&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsedata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">msg</span>
    
    <span class="k">def</span> <span class="nf">_got_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsedata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">msg</span>


<span class="k">class</span> <span class="nc">HttpParseError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="HttpResponse"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse">[docs]</a><span class="k">class</span> <span class="nc">HttpResponse</span><span class="p">(</span><span class="n">IOClientRead</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An Http response object.</span>

<span class="sd">.. attribute:: status_code</span>

<span class="sd">    Integer indicating the status code</span>

<span class="sd">.. attribute:: history</span>

<span class="sd">    A list of :class:`HttpResponse` objects from the history of the</span>
<span class="sd">    class:`HttpRequest`. Any redirect responses will end up here.</span>
<span class="sd">    </span>
<span class="sd">.. attribute:: streaming</span>

<span class="sd">    boolean indicating if this is a streaming HTTP response.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">will_close</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">parser_class</span> <span class="o">=</span> <span class="n">HttpParser</span>
    <span class="n">again</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">debuglevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">=</span> <span class="n">debuglevel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&lt;None&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="HttpResponse.streaming"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.streaming">[docs]</a>    <span class="k">def</span> <span class="nf">streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">stream</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="HttpResponse.status_code"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.status_code">[docs]</a>    <span class="k">def</span> <span class="nf">status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_status_code</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_body</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_headers_complete</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_headers</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">is_succesful</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span>
       
    <span class="nd">@property</span>
<div class="viewcode-block" id="HttpResponse.history"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.history">[docs]</a>    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">history</span>
       </div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">client</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span>
        
<div class="viewcode-block" id="HttpResponse.content_string"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.content_string">[docs]</a>    <span class="k">def</span> <span class="nf">content_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Decode content as a string.&#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span> <span class="ow">or</span> <span class="s">&#39;strict&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpResponse.content_json"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.content_json">[docs]</a>    <span class="k">def</span> <span class="nf">content_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Decode content as a JSON object.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_string</span><span class="p">(</span><span class="n">charset</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpResponse.raise_for_status"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.raise_for_status">[docs]</a>    <span class="k">def</span> <span class="nf">raise_for_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raises stored :class:`HTTPError` or :class:`URLError`,</span>
<span class="sd"> if one occured.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpResponse.begin"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">decompress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Start reading the response. Called by the connection object.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_class</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decompress</span><span class="o">=</span><span class="n">decompress</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="HttpResponse.write"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Send data to remote server. This can be used in a Exect/continue</span>
<span class="sd">situation. Return a deferred if asynchronous.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DEFAULT_CHARSET</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_class</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">decompress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">decompress</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;No connection. Response closed.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpResponse.parsedata"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.parsedata">[docs]</a>    <span class="k">def</span> <span class="nf">parsedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called when data is available on the pipeline&#39;&#39;&#39;</span>
        <span class="n">had_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_headers_complete</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
                <span class="c"># if headers are ready, try to close the response</span>
                <span class="k">if</span> <span class="n">had_headers</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_headers_complete</span><span class="p">():</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">build_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">():</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">res</span>
            <span class="c"># Not streaming. wait until we have the whole message</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_headers_complete</span><span class="p">()</span> <span class="ow">and</span>\
                 <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">build_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># This is an error in the parsing. Raise an error so that the</span>
            <span class="c"># connection is closed</span>
            <span class="k">raise</span> <span class="n">HttpParseError</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="HttpResponse.isclosed"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.isclosed">[docs]</a>    <span class="k">def</span> <span class="nf">isclosed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Required by python HTTPConnection. It is ``True`` when the</span>
<span class="sd">:class:`HttpResponse` has received all data (headers and body).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

<div class="viewcode-block" id="HttpResponse.stream"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpResponse.stream">[docs]</a>    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a generator of parsed body data. This is available when</span>
<span class="sd">the client is in a streaming mode.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_streamed&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Already streamed&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_streamed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">():</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">recv_body</span><span class="p">()</span>
            <span class="c"># last part only if boy is available</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">recv_body</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">b</span>
    </div>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">():</span>
            <span class="c"># release the connection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">again</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">new_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">release_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
            
</div>
<span class="k">class</span> <span class="nc">HttpConnection</span><span class="p">(</span><span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Http Connection class&#39;&#39;&#39;</span>
    <span class="n">tunnel_class</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPResponse</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">source_address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_address</span> <span class="o">=</span> <span class="n">source_address</span>
    
    <span class="k">def</span> <span class="nf">_tunnel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tunnel_class</span>
        <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="o">.</span><span class="n">_tunnel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="n">response_class</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">gettimeout</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="k">else</span> <span class="bp">False</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to the host and port specified in __init__.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tunnel_host</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tunnel</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">ispy26</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">set_tunnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_tunnel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HttpsConnection</span><span class="p">(</span><span class="n">HttpConnection</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Https Connection class.&#39;&#39;&#39;</span>
    <span class="n">default_port</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPS_PORT</span>

    <span class="k">def</span> <span class="nf">set_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">cert_reqs</span><span class="o">=</span><span class="s">&#39;CERT_NONE&#39;</span><span class="p">,</span> <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">ssl_req_scheme</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;CERT_NONE&#39;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span>
            <span class="s">&#39;CERT_OPTIONAL&#39;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span><span class="p">,</span>
            <span class="s">&#39;CERT_REQUIRED&#39;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_file</span> <span class="o">=</span> <span class="n">key_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cert_file</span> <span class="o">=</span> <span class="n">cert_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl_req_scheme</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cert_reqs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">ca_certs</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Connect to a host on a given (SSL) port.&quot;</span>
        <span class="n">HttpConnection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_file</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cert_file</span><span class="p">,</span>
                                    <span class="n">cert_reqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cert_reqs</span><span class="p">,</span>
                                    <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ssl</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>


<span class="k">class</span> <span class="nc">HttpBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">HOOKS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="s">&#39;pre_request&#39;</span><span class="p">,</span> <span class="s">&#39;pre_send&#39;</span><span class="p">,</span> <span class="s">&#39;post_request&#39;</span><span class="p">,</span> <span class="s">&#39;response&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Register an event hook&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispatch_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">hook_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches a hook dictionary on a given piece of data.&quot;&quot;&quot;</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span>
        <span class="k">if</span> <span class="n">hooks</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hook</span><span class="p">(</span><span class="n">hook_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Unhandled error in </span><span class="si">%s</span><span class="s"> hook&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span>
                                    <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_basic_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a :class:`HTTPBasicAuth` handler to the *pre_requests* hooks.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_hook</span><span class="p">(</span><span class="s">&#39;pre_request&#39;</span><span class="p">,</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">add_digest_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_hook</span><span class="p">(</span><span class="s">&#39;pre_request&#39;</span><span class="p">,</span> <span class="n">HTTPDigestAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">has_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<div class="viewcode-block" id="HttpRequest"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpRequest">[docs]</a><span class="k">class</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="n">HttpBase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Http client request initialised by a call to the</span>
<span class="sd">:class:`HttpClient.request` method.</span>

<span class="sd">.. attribute:: client</span>

<span class="sd">    The :class:`HttpClient` performing the request</span>

<span class="sd">.. attribute:: type</span>

<span class="sd">    The scheme of the of the URI requested. One of http, https</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">response_class</span> <span class="o">=</span> <span class="n">HttpResponse</span>

    <span class="n">_tunnel_host</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_has_proxy</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">encode_multipart</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">multipart_boundary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hooks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">max_redirects</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>\
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_full_url</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span> <span class="o">=</span> <span class="n">max_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_redirects</span> <span class="o">=</span> <span class="n">allow_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span> <span class="ow">or</span> <span class="n">DEFAULT_CHARSET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="c"># Pre-request hook.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_hook</span><span class="p">(</span><span class="s">&#39;pre_request&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encode_multipart</span><span class="p">,</span> <span class="n">multipart_boundary</span><span class="p">)</span>

<div class="viewcode-block" id="HttpRequest.execute"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpRequest.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tried</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Submit request and return a :attr:`response_class` instance.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tunnel_host</span><span class="p">:</span>
            <span class="n">tunnel_headers</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">proxy_auth_hdr</span> <span class="o">=</span> <span class="s">&quot;Proxy-Authorization&quot;</span>
            <span class="k">if</span> <span class="n">proxy_auth_hdr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">tunnel_headers</span><span class="p">[</span><span class="n">proxy_auth_hdr</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="n">proxy_auth_hdr</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">proxy_auth_hdr</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">set_tunnel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunnel_host</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">tunnel_headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_hook</span><span class="p">(</span><span class="s">&#39;pre_send&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">decompress</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tried</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">release_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_proxy</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">?</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>

    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>

    <span class="k">def</span> <span class="nf">host_and_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">host_and_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_unredirected_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">header_field</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">set_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&#39;https&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tunnel_host</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tunnel_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_proxy</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>

    <span class="k">def</span> <span class="nf">has_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_proxy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_and_port</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_unverifiable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
    <span class="c"># python 3.3 compatibility</span>
    <span class="n">unverifiable</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">is_unverifiable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encode_multipart</span><span class="p">,</span> <span class="n">multipart_boundary</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">ENCODE_URL_METHODS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_encode_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">elif</span> <span class="n">is_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content-type&#39;</span><span class="p">)</span>
            <span class="c"># No content type given</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span>
                <span class="k">if</span> <span class="n">encode_multipart</span><span class="p">:</span>
                    <span class="n">body</span><span class="p">,</span> <span class="n">content_type</span> <span class="o">=</span> <span class="n">encode_multipart_formdata</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                <span class="n">boundary</span><span class="o">=</span><span class="n">multipart_boundary</span><span class="p">,</span>
                                                <span class="n">charset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
            <span class="k">elif</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s">&#39;application/json&#39;</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin-1&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">_encode_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_string_or_native_string</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">query</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_full_url</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_full_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">urlunparse</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="HttpRequest.get_full_url"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpRequest.get_full_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Needed so that this class is compatible with the Request class</span>
<span class="sd">in the http.client module in the standard library.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_url</span>
    </div>
    <span class="k">def</span> <span class="nf">get_origin_req_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">request</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="k">else</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">request_host</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">HttpConnectionPool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Maintains a pool of connections&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_created_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_use_connections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">https_params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get a connection from the pool&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="n">closed</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_connections</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">closed</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">closed</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_connection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_use_connections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Create a new connection&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_connections</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">max_connections</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HttpConnectionError</span><span class="p">(</span><span class="s">&quot;Too many connections&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_created_connections</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&#39;https&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SSLError</span><span class="p">(</span><span class="s">&quot;Can&#39;t connect to HTTPS URL because the SSL &quot;</span>
                               <span class="s">&quot;module is not available.&quot;</span><span class="p">)</span>
            <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">https_connection</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">con</span><span class="o">.</span><span class="n">set_cert</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">https_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">http_connection</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">con</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">return</span> <span class="n">con</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="s">&quot;Releases the connection back to the pool&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_use_connections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove the *connection* from the pool&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_use_connections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="HttpClient"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient">[docs]</a><span class="k">class</span> <span class="nc">HttpClient</span><span class="p">(</span><span class="n">HttpBase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A client for an HTTP/HTTPS server which handles a pool of synchronous</span>
<span class="sd">or asynchronous connections.</span>

<span class="sd">.. attribute:: headers</span>

<span class="sd">    Default headers for this :class:`HttpClient`. If supplied, it must be an</span>
<span class="sd">    iterable over two-elements tuple.</span>

<span class="sd">    Default: ``None``.</span>

<span class="sd">.. attribute:: cookies</span>

<span class="sd">    Default cookies for this :class:`HttpClient`</span>

<span class="sd">    Default: ``None``.</span>

<span class="sd">.. attribute:: timeout</span>

<span class="sd">    Default timeout for the connecting sockets. If 0 it is an asynchronous</span>
<span class="sd">    client.</span>

<span class="sd">.. attribute:: hooks</span>

<span class="sd">    Dictionary of event-handling hooks (idea from request_).</span>

<span class="sd">.. attribute:: encode_multipart</span>

<span class="sd">    Flag indicating if body data is encoded using the ``multipart/form-data``</span>
<span class="sd">    encoding by default.</span>

<span class="sd">    Default: ``True``</span>

<span class="sd">.. attribute:: DEFAULT_HTTP_HEADERS</span>

<span class="sd">    Default headers for this :class:`HttpClient`</span>

<span class="sd">.. attribute:: proxy_info</span>

<span class="sd">    Dictionary of proxy servers for this client.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">allow_redirects</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">request_class</span> <span class="o">=</span> <span class="n">HttpRequest</span>
    <span class="sd">&#39;&#39;&#39;Class handling requests. Default: :class:`HttpRequest`&#39;&#39;&#39;</span>
    <span class="n">connection_pool</span> <span class="o">=</span> <span class="n">HttpConnectionPool</span>
    <span class="n">http_connection</span> <span class="o">=</span> <span class="n">HttpConnection</span>
    <span class="sd">&#39;&#39;&#39;Class handling HTTP connections. Default: :class:`HttpConnection`&#39;&#39;&#39;</span>
    <span class="n">https_connection</span> <span class="o">=</span> <span class="n">HttpsConnection</span>
    <span class="sd">&#39;&#39;&#39;Class handling HTTPS connections. Default: :class:`HttpsConnection`&#39;&#39;&#39;</span>
    <span class="n">client_version</span> <span class="o">=</span> <span class="s">&#39;Python-httpurl&#39;</span>
    <span class="n">DEFAULT_HTTP_HEADERS</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">([</span>
            <span class="p">(</span><span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&#39;Keep-Alive&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;identity&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;deflate&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;compress&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;gzip&#39;</span><span class="p">)],</span>
            <span class="n">kind</span><span class="o">=</span><span class="s">&#39;client&#39;</span><span class="p">)</span>
    <span class="n">request_parameters</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;hooks&#39;</span><span class="p">,</span> <span class="s">&#39;encode_multipart&#39;</span><span class="p">,</span> <span class="s">&#39;timeout&#39;</span><span class="p">,</span>
                          <span class="s">&#39;max_redirects&#39;</span><span class="p">,</span> <span class="s">&#39;allow_redirects&#39;</span><span class="p">,</span>
                          <span class="s">&#39;multipart_boundary&#39;</span><span class="p">,</span> <span class="s">&#39;stream&#39;</span><span class="p">)</span>
    <span class="c"># Default hosts not affected by proxy settings. This can be overwritten</span>
    <span class="c"># by specifying the &quot;no&quot; key in the proxy_info dictionary</span>
    <span class="n">no_proxy</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">urllibr</span><span class="o">.</span><span class="n">localhost</span><span class="p">(),</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">encode_multipart</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">client_version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">multipart_boundary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_connections</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="s">&#39;CERT_NONE&#39;</span><span class="p">,</span>
                 <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">store_cookies</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_redirects</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">decompress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trust_env</span> <span class="o">=</span> <span class="n">trust_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_cookies</span> <span class="o">=</span> <span class="n">store_cookies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span> <span class="o">=</span> <span class="n">max_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poolmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">cookies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompress</span> <span class="o">=</span> <span class="n">decompress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span> <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="n">max_connections</span> <span class="ow">or</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span>
        <span class="n">dheaders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_HTTP_HEADERS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_version</span> <span class="o">=</span> <span class="n">client_version</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_version</span>
        <span class="n">dheaders</span><span class="p">[</span><span class="s">&#39;user-agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_version</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">dheaders</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">event</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">HOOKS</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">dheaders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proxy_info</span> <span class="ow">or</span> <span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trust_env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="n">get_environ_proxies</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;no&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">[</span><span class="s">&#39;no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_proxy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode_multipart</span> <span class="o">=</span> <span class="n">encode_multipart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipart_boundary</span> <span class="o">=</span> <span class="n">multipart_boundary</span> <span class="ow">or</span> <span class="n">choose_boundary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">https_defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;key_file&#39;</span><span class="p">:</span> <span class="n">key_file</span><span class="p">,</span>
                               <span class="s">&#39;cert_file&#39;</span><span class="p">:</span> <span class="n">cert_file</span><span class="p">,</span>
                               <span class="s">&#39;cert_reqs&#39;</span><span class="p">:</span> <span class="n">cert_reqs</span><span class="p">,</span>
                               <span class="s">&#39;ca_certs&#39;</span><span class="p">:</span> <span class="n">ca_certs</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">websocket_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_websocket_key&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_key</span> <span class="o">=</span> <span class="n">native_str</span><span class="p">(</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)),</span>
                                             <span class="s">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_key</span>
            
<div class="viewcode-block" id="HttpClient.get_headers"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.get_headers">[docs]</a>    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a :class:`Header` obtained from combining</span>
<span class="sd">:attr:`headers` with *headers*. It handles websocket requests.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ws&#39;</span><span class="p">,</span><span class="s">&#39;wss&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(((</span><span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&#39;Upgrade&#39;</span><span class="p">),</span>
                         <span class="p">(</span><span class="s">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s">&#39;websocket&#39;</span><span class="p">),</span>
                         <span class="p">(</span><span class="s">&#39;Sec-WebSocket-Version&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">WEBSOCKET_VERSION</span><span class="p">))),</span>
                         <span class="p">(</span><span class="s">&#39;Sec-WebSocket-Key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_key</span><span class="p">),</span>
                         <span class="p">(</span><span class="s">&#39;user-agent&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_version</span><span class="p">)),</span>
                         <span class="n">kind</span><span class="o">=</span><span class="s">&#39;client&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="HttpClient.get"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a GET request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;allow_redirects&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.options"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.options">[docs]</a>    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a OPTIONS request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;allow_redirects&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.head"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.head">[docs]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a HEAD request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.post"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a POST request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.put"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a PUT request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.patch"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.patch">[docs]</a>    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a PATCH request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;PATCH&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.delete"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends a DELETE request and returns a :class:`HttpResponse`</span>
<span class="sd">object.</span>

<span class="sd">:params url: url for the new :class:`HttpRequest` object.</span>
<span class="sd">:param \*\*kwargs: Optional arguments for the :meth:`request` method.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HttpClient.request"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Constructs and sends an :class:`HttpRequest` to a remote server.</span>
<span class="sd">It returns an :class:`HttpResponse` object.</span>

<span class="sd">:param method: request method for the :class:`HttpRequest`.</span>
<span class="sd">:param url: URL for the :class:`HttpRequest`.</span>
<span class="sd">:param params: a dictionary which specify all the optional parameters for</span>
<span class="sd">the :class:`HttpRequest` constructor.</span>

<span class="sd">:rtype: a :class:`HttpResponse` object.</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_parameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="c"># Set proxy if required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_proxy</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">add_cookie_header</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">CookieJar</span><span class="p">):</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="n">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
            <span class="n">cookies</span><span class="o">.</span><span class="n">add_cookie_header</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_set_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">CookieJar</span><span class="p">):</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="n">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="n">CookieJar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="n">cookies</span>
    <span class="k">def</span> <span class="nf">_get_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_cookies</span><span class="p">,</span> <span class="n">_set_cookies</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">key</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poolmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&#39;https&#39;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">https_defaults</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poolmap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">response_class</span>
        <span class="k">return</span> <span class="n">connection</span>

<div class="viewcode-block" id="HttpClient.release_connection"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.release_connection">[docs]</a>    <span class="k">def</span> <span class="nf">release_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Release teh connection in *request*&#39;&#39;&#39;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">key</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poolmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="HttpClient.upgrade"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Upgrade a :class:`HttpResponse` (for websocket).</span>
<span class="sd">Requires implementation.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">set_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">:</span>
            <span class="n">hostonly</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">splitport</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="n">no_proxy</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;no&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">hostonly</span><span class="o">.</span><span class="n">endswith</span><span class="p">,</span> <span class="n">no_proxy</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
                <span class="n">request</span><span class="o">.</span><span class="n">set_proxy</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>

<div class="viewcode-block" id="HttpClient.build_response"><a class="viewcode-back" href="../../../http.html#pulsar.utils.httpurl.HttpClient.build_response">[docs]</a>    <span class="k">def</span> <span class="nf">build_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The response headers are available. Build the response.&#39;&#39;&#39;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">request</span>
        <span class="n">request</span><span class="o">.</span><span class="n">dispatch_hook</span><span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
        <span class="c"># store cookies in clinet if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_cookies</span> <span class="ow">and</span> <span class="s">&#39;set-cookie&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">extract_cookies</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="c"># check redirect</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">REDIRECT_CODES</span> <span class="ow">and</span> <span class="s">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="ow">and</span>\
                <span class="n">request</span><span class="o">.</span><span class="n">allow_redirects</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;location&#39;</span><span class="p">)</span>
            <span class="c"># Handle redirection without scheme (see: RFC 1808 Section 4)</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
                <span class="n">parsed_rurl</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parsed_rurl</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="c"># Facilitate non-RFC2616-compliant &#39;location&#39; headers</span>
            <span class="c"># (e.g. &#39;/path/to/resource&#39; instead of</span>
            <span class="c"># &#39;http://domain.tld/path/to/resource&#39;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">,</span>
                              <span class="c"># Compliant with RFC3986, we percent</span>
                              <span class="c"># encode the url.</span>
                              <span class="n">requote_uri</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c"># Continue with current response</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">101</span><span class="p">:</span>
                <span class="c"># Upgrading response handler</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upgrade</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We need to read the rest of the message</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        </div>
    <span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">request</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">full_url</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">history</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">request</span><span class="o">.</span><span class="n">max_redirects</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TooManyRedirects</span><span class="p">()</span>
        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_connection</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span>
        <span class="c"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.4</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="mi">303</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;GET&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;Cookie&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># Build a new request</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                            <span class="n">encode_multipart</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_multipart</span><span class="p">,</span>
                            <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">,</span>
                            <span class="n">max_redirects</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_redirects</span><span class="p">,</span>
                            <span class="n">allow_redirects</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">allow_redirects</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">_update_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;hooks&#39;</span><span class="p">:</span>
            <span class="n">hooks</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">chooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">e</span><span class="p">,</span> <span class="n">copy</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">hooks</span><span class="p">):</span>
                <span class="n">chooks</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">chooks</span>


<span class="c">###############################################    AUTHENTICATION</span></div>
<span class="k">class</span> <span class="nc">Auth</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class that all auth implementations derive from&quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Auth hooks must be callable.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">HTTPBasicAuth</span><span class="p">(</span><span class="n">Auth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attaches HTTP Basic Authentication to the given Request object.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;basic&#39;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_auth_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Basic: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>


<span class="k">class</span> <span class="nc">HTTPDigestAuth</span><span class="p">(</span><span class="n">Auth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attaches HTTP Digest Authentication to the given Request object.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_nonce</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s">&#39;MD5&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;digest&#39;</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c"># If we have a saved nonce, skip the 401</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_nonce</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">register_hook</span><span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_401</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Digest: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>

    <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called by the server to check if client is authenticated.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="n">qop</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;qop&#39;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ha1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha1</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s">&#39;realm&#39;</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">ha2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha2</span><span class="p">(</span><span class="n">qop</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">hexmd5</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ha1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ha2</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span> <span class="ow">or</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&#39;auth-int&#39;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">hexmd5</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ha1</span><span class="p">,</span> <span class="n">o</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">],</span>
                                        <span class="n">o</span><span class="p">[</span><span class="s">&#39;cnonce&#39;</span><span class="p">],</span> <span class="n">qop</span><span class="p">,</span> <span class="n">ha2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;qop value are wrong&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called by the client to encode Authentication header.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="n">qop</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;qop&#39;</span><span class="p">)</span>
        <span class="n">realm</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;realm&#39;</span><span class="p">)</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">]</span>
        <span class="n">entdig</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">p_parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">p_parsed</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">p_parsed</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">p_parsed</span><span class="o">.</span><span class="n">query</span>
        <span class="n">KD</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">ha1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha1</span><span class="p">(</span><span class="n">realm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="n">ha2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha2</span><span class="p">(</span><span class="n">qop</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nonce</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_nonce</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonce_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonce_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ncvalue</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%08x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce_count</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce_count</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">nonce</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">cnonce</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
            <span class="n">noncebit</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ncvalue</span><span class="p">,</span> <span class="n">cnonce</span><span class="p">,</span> <span class="n">qop</span><span class="p">,</span> <span class="n">ha2</span><span class="p">)</span>
            <span class="n">respdig</span> <span class="o">=</span> <span class="n">KD</span><span class="p">(</span><span class="n">ha1</span><span class="p">,</span> <span class="n">noncebit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">qop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">respdig</span> <span class="o">=</span> <span class="n">KD</span><span class="p">(</span><span class="n">ha1</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ha2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># XXX handle auth-int.</span>
            <span class="k">return</span>
        <span class="n">base</span> <span class="o">=</span> <span class="s">&#39;username=&quot;</span><span class="si">%s</span><span class="s">&quot;, realm=&quot;</span><span class="si">%s</span><span class="s">&quot;, nonce=&quot;</span><span class="si">%s</span><span class="s">&quot;, uri=&quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> \
               <span class="s">&#39;response=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">realm</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">respdig</span><span class="p">)</span>
        <span class="n">opaque</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;opaque&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opaque</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="s">&#39;, opaque=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">opaque</span>
        <span class="k">if</span> <span class="n">entdig</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="s">&#39;, digest=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">entdig</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="s">&#39;, algorithm=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span>
        <span class="k">if</span> <span class="n">qop</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="s">&#39;, qop=</span><span class="si">%s</span><span class="s">, nc=</span><span class="si">%s</span><span class="s">, cnonce=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qop</span><span class="p">,</span> <span class="n">ncvalue</span><span class="p">,</span> <span class="n">cnonce</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;Digest </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">handle_401</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes the given response and tries digest-auth, if needed.&quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">request</span>
        <span class="n">num_401_calls</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_401</span><span class="p">)</span>
        <span class="n">s_auth</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;www-authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;digest&#39;</span> <span class="ow">in</span> <span class="n">s_auth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">num_401_calls</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">parse_dict_header</span><span class="p">(</span><span class="n">s_auth</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Digest &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                                           <span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">again</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">response</span>
    
    <span class="k">def</span> <span class="nf">hex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s">&#39;MD5&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hexmd5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s">&#39;SHA1&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hexsha1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">valueError</span><span class="p">(</span><span class="s">&#39;Unknown algorithm </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">ha1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">realm</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">realm</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">ha2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qop</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&quot;auth&quot;</span> <span class="ow">or</span> <span class="n">qop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&quot;auth-int&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="n">body</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">WWWAuthenticate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_require_quoting</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="s">&#39;nonce&#39;</span><span class="p">,</span> <span class="s">&#39;opaque&#39;</span><span class="p">,</span> <span class="s">&#39;realm&#39;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">basic</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="s">&#39;authentication required&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the auth info and enable basic auth.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="s">&#39;basic&#39;</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">realm</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">realm</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">qop</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;auth&#39;</span><span class="p">,),</span> <span class="n">opaque</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">algorithm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">stale</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;stale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TRUE&#39;</span>
        <span class="k">if</span> <span class="n">opaque</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;opaque&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opaque</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="s">&#39;digest&#39;</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="n">realm</span><span class="p">,</span> <span class="n">nonce</span><span class="o">=</span><span class="n">nonce</span><span class="p">,</span>
                   <span class="n">qop</span><span class="o">=</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qop</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the stored values into a WWW-Authenticate header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">quote_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                                <span class="n">allow_token</span><span class="o">=</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_require_quoting</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="p">)))</span>
    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
        
<span class="c">###############################################    UTILITIES, ENCODERS, PARSERS</span>
<span class="k">def</span> <span class="nf">get_environ_proxies</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dict of environment proxies. From requests_.&quot;&quot;&quot;</span>

    <span class="n">proxy_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;all&#39;</span><span class="p">,</span>
        <span class="s">&#39;http&#39;</span><span class="p">,</span>
        <span class="s">&#39;https&#39;</span><span class="p">,</span>
        <span class="s">&#39;ftp&#39;</span><span class="p">,</span>
        <span class="s">&#39;socks&#39;</span><span class="p">,</span>
        <span class="s">&#39;no&#39;</span>
    <span class="p">]</span>

    <span class="n">get_proxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">proxies</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;_proxy&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proxy_keys</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proxies</span> <span class="k">if</span> <span class="n">val</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">addslash</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Add a slash at the beginning of *url*.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">url</span>
    <span class="k">return</span> <span class="n">url</span>

<span class="k">def</span> <span class="nf">appendslash</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Append a slash to *url* if it does not have one.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="n">url</span>
    <span class="k">return</span> <span class="n">url</span>

<span class="k">def</span> <span class="nf">choose_boundary</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Our embarassingly-simple replacement for mimetools.choose_boundary.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

<span class="k">def</span> <span class="nf">get_content_type</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;application/octet-stream&#39;</span>

<span class="k">def</span> <span class="nf">encode_multipart_formdata</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode a dictionary of ``fields`` using the multipart/form-data mime format.</span>

<span class="sd">    :param fields:</span>
<span class="sd">        Dictionary of fields or list of (key, value) field tuples.  The key is</span>
<span class="sd">        treated as the field name, and the value as the body of the form-data</span>
<span class="sd">        bytes. If the value is a tuple of two elements, then the first element</span>
<span class="sd">        is treated as the filename of the form-data section.</span>

<span class="sd">        Field names and filenames must be unicode.</span>

<span class="sd">    :param boundary:</span>
<span class="sd">        If not specified, then a random boundary will be generated using</span>
<span class="sd">        :func:`mimetools.choose_boundary`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span> <span class="ow">or</span> <span class="n">DEFAULT_CHARSET</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">boundary</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">choose_boundary</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;--</span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;Content-Disposition: form-data; name=&quot;</span><span class="si">%s</span><span class="s">&quot;; &#39;</span>
                        <span class="s">&#39;filename=&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>\
                       <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;Content-Type: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">get_content_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;Content-Disposition: form-data; name=&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;--</span><span class="si">%s</span><span class="s">--</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">boundary</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">charset</span><span class="p">))</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;multipart/form-data; boundary=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">boundary</span>
    <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">content_type</span>

<span class="k">def</span> <span class="nf">hexmd5</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">hexsha1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sha1</span><span class="p">(</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">basic_auth_str</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a Basic Auth string.&quot;&quot;&quot;</span>
    <span class="n">b64</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">((</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin1&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&#39;Basic </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">native_str</span><span class="p">(</span><span class="n">b64</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s">&#39;latin1&#39;</span><span class="p">)</span>
    

<span class="n">digest_parameters</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;realm&#39;</span><span class="p">,</span> <span class="s">&#39;nonce&#39;</span><span class="p">,</span> <span class="s">&#39;uri&#39;</span><span class="p">,</span> <span class="s">&#39;nc&#39;</span><span class="p">,</span>
                             <span class="s">&#39;cnonce&#39;</span><span class="p">,</span>  <span class="s">&#39;response&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">parse_authorization_header</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse an HTTP basic/digest authorization header transmitted by the web</span>
<span class="sd">browser.  The return value is either `None` if the header was invalid or</span>
<span class="sd">not given, otherwise an :class:`Auth` object.</span>

<span class="sd">:param value: the authorization header to parse.</span>
<span class="sd">:return: a :class:`Auth` or `None`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth_type</span><span class="p">,</span> <span class="n">auth_info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">auth_info</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;latin-1&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
            <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">auth_type</span> <span class="o">==</span> <span class="s">&#39;digest&#39;</span><span class="p">:</span>
        <span class="n">auth_map</span> <span class="o">=</span> <span class="n">parse_dict_header</span><span class="p">(</span><span class="n">auth_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">digest_parameters</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">auth_map</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HTTPDigestAuth</span><span class="p">(</span><span class="n">auth_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">),</span>
                                  <span class="n">options</span><span class="o">=</span><span class="n">auth_map</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">http_date</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the time to match the RFC1123 date format as specified by HTTP</span>
<span class="sd">    RFC2616 section 3.3.1.</span>

<span class="sd">    Accepts a floating point number expressed in seconds since the epoch, in</span>
<span class="sd">    UTC - such as that outputted by time.time(). If set to None, defaults to</span>
<span class="sd">    the current time.</span>

<span class="sd">    Outputs a string in the format &#39;Wdy, DD Mon YYYY HH:MM:SS GMT&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">formatdate</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="p">,</span> <span class="n">usegmt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">#################################################################### COOKIE</span>
<span class="k">def</span> <span class="nf">create_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a cookie from underspecified parameters.</span>

<span class="sd">    By default, the pair of `name` and `value` will be set for the domain &#39;&#39;</span>
<span class="sd">    and sent on every request (this is sometimes called a &quot;supercookie&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">expires</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">discard</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">comment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">comment_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">rest</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;HttpOnly&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
        <span class="n">rfc2109</span><span class="o">=</span><span class="bp">False</span><span class="p">,)</span>
    <span class="n">badargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">badargs</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;create_cookie() got unexpected keyword arguments: </span><span class="si">%s</span><span class="s">&#39;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">badargs</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;port_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;domain_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">])</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;domain_initial_dot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s">&#39;path_specified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Cookie</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookie_dict</span><span class="p">,</span> <span class="n">cookiejar</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a CookieJar from a key/value dictionary.</span>

<span class="sd">    :param cookie_dict: Dict of key/values to insert into CookieJar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cookiejar</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cookiejar</span> <span class="o">=</span> <span class="n">CookieJar</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cookie_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cookie_dict</span><span class="p">:</span>
            <span class="n">cookiejar</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">create_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cookie_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">cookiejar</span>

<span class="k">def</span> <span class="nf">parse_cookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cookie</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">BaseCookie</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CookieError</span><span class="p">:</span>
            <span class="c"># Invalid cookie</span>
            <span class="k">return</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cookie</span>
    <span class="n">cookiedict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cookiedict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">cookiedict</span>


<span class="n">cc_delim_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\s*,\s*&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">accept_content_type</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="nb">all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span>
            <span class="n">accept_headers</span> <span class="o">=</span> <span class="n">cc_delim_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">accept_headers</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
                        <span class="nb">all</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">all</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">:</span>
            <span class="c"># If no Accept header field is present, then it is assumed that the</span>
            <span class="c"># client accepts all media types.</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
            <span class="nb">all</span> <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;*&#39;</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">all</span>
        <span class="k">elif</span> <span class="s">&#39;*&#39;</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">patch_vary_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">newheaders</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Adds (or updates) the &quot;Vary&quot; header in the given HttpResponse object.</span>
<span class="sd">newheaders is a list of header names that should be in &quot;Vary&quot;. Existing</span>
<span class="sd">headers in &quot;Vary&quot; aren&#39;t removed.</span>

<span class="sd">For information on the Vary header, see:</span>

<span class="sd">    http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.44</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Note that we need to keep the original order intact, because cache</span>
    <span class="c"># implementations may rely on the order of the Vary contents in, say,</span>
    <span class="c"># computing an MD5 hash.</span>
    <span class="k">if</span> <span class="s">&#39;Vary&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">cc_delim_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vary_headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Use .lower() here so we treat headers as case-insensitive.</span>
    <span class="n">existing_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">])</span>
    <span class="n">additional_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">newheader</span> <span class="k">for</span> <span class="n">newheader</span> <span class="ow">in</span> <span class="n">newheaders</span>
                          <span class="k">if</span> <span class="n">newheader</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_headers</span><span class="p">]</span>
    <span class="n">response</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vary_headers</span> <span class="o">+</span> <span class="n">additional_headers</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">has_vary_header</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">header_query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks to see if the response has a given header name in its Vary header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="s">&#39;Vary&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">cc_delim_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">])</span>
    <span class="n">existing_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">header_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">existing_headers</span>


<span class="k">class</span> <span class="nc">CacheControl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    http://www.mnot.net/cache_docs/</span>

<span class="sd">.. attribute:: maxage</span>

<span class="sd">    Specifies the maximum amount of time that a representation will be</span>
<span class="sd">    considered fresh.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">must_revalidate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxy_revalidate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">nostore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span> <span class="o">=</span> <span class="n">maxage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">private</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_revalidate</span> <span class="o">=</span> <span class="n">must_revalidate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_revalidate</span> <span class="o">=</span> <span class="n">proxy_revalidate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nostore</span> <span class="o">=</span> <span class="n">nostore</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nostore</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no-store&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;max-age=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxage</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s">&#39;private&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s">&#39;public&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_revalidate</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s">&#39;must-revalidate&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_revalidate</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s">&#39;proxy-revalidate&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no-cache&#39;</span>
</pre></div>

          </div>
        </div>
      </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="../../../index.html">
  <img class="logo" width="200" src="../../../static/pulsar.png" alt="pulsar" title="Pulsar"/>
</a>
</p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pulsar v0.4.4b1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../pulsar.html" >pulsar</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Luca Sbardella.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  
  _gaq.push(['_setAccount', 'UA-3900561-8']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>