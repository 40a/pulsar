version: 2
jobs:
    build-main:
        working_directory: ~/pulsar-current
        docker:
          - image: python:3.6.3
          - image: redis
        steps:
          - checkout
          - run:
              name: install packages
              command: ci/install.sh
          - run:
              name: test
              command: make compile && make test
          - run:
              name: docs
              command: make docs
    build-coverage:
        working_directory: ~/pulsar-coverage
        docker:
          - image: python:3.6.3
          - image: redis
        steps:
          - checkout
          - run:
              name: install packages
              command: ci/install.sh
          - run:
              name: run and publish coverage
              command: make coverage && codecov
    build-lagacy:
        working_directory: ~/pulsar-legacy
        docker:
          - image: python:3.5.4
          - image: redis
        steps:
          - checkout
          - run:
              name: install packages
              command: ci/install.sh
          - run:
              name: test
              command: make compile && make test
    build-dev:
        working_directory: ~/pulsar-dev
        docker:
          - image: python:3.7-rc
          - image: redis
        steps:
          - checkout
          - run:
              name: install packages
              command: ci/install.sh
          - run:
              name: test
              command: make compile && make test
    deploy:
        machine: true
        environment:
          - PYTHON_VERSIONS: 3.5 3.6
          - PYMODULE: pulsar
        steps:
          - checkout
          - run:
              name: install ci packages
              command: pip install -r ci/requirements.txt
          - run:
              name: check PyPI version
              command: python setup.py pypi --final
          - run:
              name: build linux wheels
              command: make linuxwheels


workflows:
  version: 2
  build-deploy:
    jobs:
      - build-main
      - build-coverage
      - build-lagacy
      - deploy:
          requires:
            - build-main
            - build-lagacy
          filters:
            branches:
              only: deploy
